# 串行通信协议与串行接口

[TOC]

## 1. 串行接口标准

### 1.1. RS232

#### 1.1.1. RS232概述

​	*RS[^5]232-C*（又称*EIA RS-232-C*）是目前最常用的一种串行通信接口（“*RS-232-C*”中的“*-C*”只不过表示*RS-232*的版本）。*RS-232*是在*1970*年由美国电子工业协会*EIA*（*Electronic Industry Association*）联合贝尔系统、调制解调器厂家以及计算机终端生产厂家共同制定的用于串行通信的标准。*RS-232*的全名是数据终端（*DTE*）和数据通信设备（*DCE*）之间串行二进制数据交换接口技术标准。该标准规定采用一个*25*个引脚的*DB-25*连接器，对连接器的每个引脚信号内容加以规定，还对各种信号的电平加以规定。后来***IBM***[^6]的计算机将RS-232简化成了*DB-9*连接器，从而成为事实标准。而工业控制的*RS-232*接口一般只使用*RXD*、*TXD*、*GND*三条线。

#### 1.1.2. RS232物理接口

​	一般设备使用的都是*9*针接口，分公口和母口。*DB-9*接口引脚如下图所示：

![1739376335040](D:\Tencent files\MobileFile\1739376335040.jpg)

​	*DB-9*各个引脚定义如下表:

| 引脚 | 简写  |   功能说明   | 引脚 | 简写  |  功能说明  |
| :--: | :---: | :----------: | :--: | :---: | :--------: |
| *1*  | *CD*  |   载波检测   | *6*  | *DSR* | 数据准备好 |
| *2*  | *RXD* |   接收数据   | *7*  | *RTS* |  请求发送  |
| *3*  | *TXD* |   发送数据   | *8*  | *CTS* |  清除发送  |
| *4*  | *DTR* | 数据终端设备 | *9*  | *RI*  |  振铃指示  |
| *5*  | *GND* |     地线     |  -   |   -   |     -      |

#### 1.1.3. RS232电气特性

对于*RXD*和*TXD*：

 	1. 逻辑1 = -15 ~ -3V；
 	2. 逻辑0 = 3 ~ 15V。

对于*RTS*、*CTS*、*DST*、*DTR*和*CD*等控制线：

1. 信号有效（接通/*ON*/正电压）= *3 ~ 15V*；
2. 信号无效（断开/*OFF*/负电压）= *-15 ~ -3V*。

> *-3 ~ 3V*的电压处于模糊区电位，此部分电压是的计算机无法正确判断输出信号的意义，可能是*0*，也可能是*1*。通信体系就会出现大量的误码造成通信失败。因此，在实际工作中，应保证传输电平在***3 ~ 15V***和***-15 ~ -3V***。

​	*RS-232C*规定最大的负载电容为*2500pF*，这个电容限制了通信距离和通信速率，由于*RS-232C*的发送器和接收器之间具有公共信号地*GND*，属于非平衡电压型传输电路，不实用差分信号，因此不具备抗共模干扰能力，共模噪声会耦合到信号中，在不使用调至解调器时，*RS-232C*能够可靠进行数据传输的最大通信距离为*15m*。通信速率越大，有效通信距离越小。

#### 1.1.4. RS232数据帧格式

​	RS-232C异步串口数据通信采用标准的数据帧格式，通信双方约定相同的波特率、数据帧格式下，即可进行通信。RS-232C数据帧格式如下：

![image-20250212234358510](C:\Users\JetzeyChen\AppData\Roaming\Typora\typora-user-images\image-20250212234358510.png)

1. 起始位：*1*bit逻辑*0*；

2. 停止位：*0.5*、*1*、*1.5*或*2bit*逻辑*1*；

3. 有效数据位：*5*、*6*、*7*或*8bit*；

4. 校验位：无、奇或偶校验；

   >奇校验：有效数据和校验位中的*1*的个数为奇数；
   >
   >偶校验：有效数据和校验位中的*1*的个数为偶数。

5. 波特率：单位为*bit/s*或者*B*（*Baud*），指每秒传输的bit位的数量，国际上规定了标准的波特率序列，为*110*、*300*、*600*、*1200*、*1800*、*2400*、*4800*、*9600*、*19200*等。

#### 1.1.5. RS232转TTL

​	为了能够同计算机接口或终端的*TTL*[^7]器件连接，必须在*EIA RS-232C*与*TTL*电路之间进行电平与逻辑关系的转换。由于RS-232电平容错范围比*TTL*电平大很多，因此，相对于*TTL*电平通信来讲，*RS-232*电平通信距离更远、可靠性更高，常用于早期工业现场。*RS-232*实际使用过程的接线图如下所示:

![1739376180595](D:\Tencent files\MobileFile\1739376180595.jpg)

​	在实际应用中存在两种电气连接方式：*TTL*电平直连和*RS-232*连接。

<img src="D:\Tencent files\MobileFile\1739376078298.jpg" alt="1739376078298"  />

### 1.2. RS422

### 1.3. RS485

### 1.4. USB



## 2. 串行通信协议

### 2.1. USART

### 2.2. IIC

#### 2.2.1. IIC协议概述

​	*IIC*(*Inter-Integrated Circuit*)协议最早由飞利浦公司在*1982*年开发，它支持设备之间的短距离通信。由于*IIC*通信需要的引脚少、硬件实现简单、可扩展性强，现在被广泛地使用在系统内多个集成电路（*IC*）之间的通信。其支持*0KHz~5MHz*的设备：普通模式（*100KHz*）、快速模式（*400KHz*）、高速模式（*3.4MHz*）和超高速模式（*5MHz*）。

>*1995*年，***Intel***在*IIC*基础上提出了*SMBus*（*System Management Bus*），它用于低速设备通信，*SMBus*把时钟频率限制在*10KHz~100KHz*。

#### 2.2.2. IIC物理层

​	*IIC*通信只需要两根双向总线，*SDA*（*Serial Data Line*）和 *SCL*（*Serial Clock Line*）。*SDA*用于传输数据，*SCL*用于同步数据收发。*SDA*以大端传输（由*MSB*至*LSB*）方式传输数据，每次传输*1Byte =8bits*。是点对点的通信方式，总线可以连接多个*IIC*通信设备，可有多个通信主机或者通信从机，但是**任一时间点**只能有一个主机。总线上的设备都有独立且唯一的地址，共*7bits*。

>*IIC*器件的*SDA*与*SCL*引脚以开漏形式接入总线，总线需要接上拉电阻，**当总线空闲时，总线均为高电平**。
>
>当多个主机占用总线时，需要使用仲裁方式决定由哪个主机占用总线，否则会发生数据冲突。
>
>*IIC*通信为**半双工通信**，同一时间只能发送或者接收。

![image-20250212153446986](C:\Users\JetzeyChen\AppData\Roaming\Typora\typora-user-images\image-20250212153446986.png)

#### 2.2.3. IIC协议层

​	协议层定义了*IIC*通信协议，完整的*IIC*通信包括开始信号、器件地址、读写控制、器件内访问地址、有效数据、应答信号和结束信号。

##### 2.2.3.1. IIC传输底层实现

 1. 数据传输：*SCL*高电平，*SDA*必须保持稳定，*SDA*上传输*1bit*数据。

 2. 数据改变：*SCL*低电平，*SDA*才可以变更电平。

    IIC位传输时序图如下：

![image-20250212155531794](C:\Users\JetzeyChen\AppData\Roaming\Typora\typora-user-images\image-20250212155531794.png)

##### 2.2.3.2. IIC总线起始/结束信号

1. 起始信号：*SCL*为高电平，*SDA*由高电平向低电平跳变，开始传输数据。

2. 结束信号：*SCL*位高电平，*SDA*由低电平向高电平跳变，结束传输数据。

   >注：起始/结束信号均由**主机**产生。且*IIC*设备不占用总线时，总线由上拉电阻拉至高电平，高电平就意味着总线没有被任何设备抢占。

​	*IIC*总线开始/结束信号时序图如下所示：

![image-20250212160318666](C:\Users\JetzeyChen\AppData\Roaming\Typora\typora-user-images\image-20250212160318666.png)

##### 2.2.3.3. IIC器件地址、读写控制、器件内访问地址

​	在*IIC*通信协议中，每个设备都具有其唯一的*7bit/10bit*（不常用）地址，在开始信号之后，主机需要发送寻址的**从机地址**。地址的格式如下所示：

![image-20250212161801876](C:\Users\JetzeyChen\AppData\Roaming\Typora\typora-user-images\image-20250212161801876.png)

​	最后一位是**读写控制**：*Read 1/Write 0*，与*7bit*地址组成一个*1Byte*数据。

​	一些元器件内部存在不同的器件或存储单元（如：寄存器），这些内部单元也具有地址，称为**器件内访问地址**（子地址）。

##### 2.2.3.4. IIC总线字节格式

​	*SDA*总线上的每个字节必须为*8bit*，传输的字节数不受限制，且从*MSB*位开始。接收器在每接收一个字节数据后都会返回发送器一个应答信号。如下图所示：

![image-20250212162748389](C:\Users\JetzeyChen\AppData\Roaming\Typora\typora-user-images\image-20250212162748389.png)

##### 2.2.3.5. IIC总线应答信号	

​	协议规定数据传输过程必须包含应答（*ACK*）。接收器通过应答告知发送的字节已被成功接收，之后发送器可以进行下一个字节的传输。主机产生数据传输过程中的所有时钟，包括**用于应答的第*9*个时钟**。发送器在应答时钟周期内释放对*SDA*总线的控制，这样接收器可以通过将*SDA*线拉低告知发送器：数据已被成功接收。

 1. *ACK*信号：第九位为低电平；

 2. *NACK*信号：第九位为高电平。

    > ​	主机发送数据，从机接收时，*ACK*信号由从机发出。当在*SCL*第*9*位时钟高电平信号期间，如果*SDA*仍然保持高电平，则主机可以直接产生*STOP*条件终止以后的传输或者继续**重复开始信号**[^1]开始一个新的传输。
    >   从机发送数据，主机读取数据时，*ACK*信号由主机给出。主机响应*ACK*表示还需要再接收数据，而当主机接收完想要的数据后，通过发送*NACK*告诉从机读取数据结束、释放总线。随后主机发送*STOP*命令，将总线释放，结束读操作。

##### 2.2.3.6. IIC总线仲裁机制

​	*SDA*总线仲裁：每个试图抢占总线的节点（设备）发送*1*位数据后，比较总线上所呈现的数据是否与自身发送的一致。是，继续发生，不是，退出竞争。

##### 2.2.3.7. IIC主机发送数据流程

1. *SDA*、*SCL*总线均为空闲状态，主机发送开始信号，开始一次通信；

2. 主机发送命令字节（由*7bit*地址与*1bit*读写控制位组成）；

3. 从机收到命令字节后返回*ACK*信号；

4. 主机收到*ACK*信号后，发送器件内部访问地址字节；

5. 从机接收成功返回*ACK*信号；

6. 主机收到*ACK*后发送下一个数据字节；

7. 从机接收成功返回*ACK*信号；

8. 主机的一次发送通信，发送的数据数量不受限制，当主机发送最后一个数据字节并收到从机的*ACK*信号后，通过向从机发送结束信号结束本次通信并释放总线。从机收到结束信号后也退出与主机之间的通信。

   ![image-20250212190408389](C:\Users\JetzeyChen\AppData\Roaming\Typora\typora-user-images\image-20250212190408389.png)

##### 2.2.3.8. IIC主机接收数据流程

 1. *SDA*、*SCL*总线均为空闲状态，主机发送开始信号，开始一次通信；

 2. 主机发送命令字节（由*7bit*地址与*1bit*读写控制位组成）；

 3. 从机收到命令字节后返回*ACK*信号；

 4. 主机收到*ACK*信号后，发送器件内部访问地址字节；

 5. 从机接收成功返回*ACK*信号；

    >以上过程为主机向从机发送从哪个寄存器读取数据。

 6. 主机收到*ACK*信号，重新产生一个起始信号；

 7. 主机发送命令字节（由*7bit*地址与*1bit*读写控制位组成）；

 8. 从机收到命令字节后返回*ACK*信号；

 9. 接着，主机接收从机发送的数据，成功接收后如果仍需接收就回复*ACK*信号；

 10. 主机接收最后一个字节数据后，向从机发送*NACK*信号；

 11. 主机发送一结束信号结束本次通信并释放总线。

     ![image-20250212190922420](C:\Users\JetzeyChen\AppData\Roaming\Typora\typora-user-images\image-20250212190922420.png)

### 2.3. SPI

##### 2.3.1.SPI协议概述

​	*SPI*（*Serial Peripheral Interface*）串行外设接口是***Motorola***首先提出的**全双工四线同步串行通信协议**，采用主从模式（*Master-Slave*）架构，支持单主多从模式应用，时钟由*Master*控制，在时钟移位脉冲下，数据按位传输，高位在前，地位在后，即*MSB First*。

##### 2.3.2. SPI物理层

​	*4*线*SPI*器件有*4*个信号：时钟信号（*SPI CLK*/*SCLK*）、主机输出从机输入信号（*MOSI*[^2]）、主机输入从机输出信号（*MISO*[^3]）、片选信号（*CS/NSS*[^4]）。

​	产生时钟信号的器件成为主机。主机与从机之间传输的数据与主机产生的时钟同步。与*IIC*接口相比，*SPI*接口支持更高的时钟频率。但是*SPI*只能有一个主机，但是可以具有多个从机。主从之间的接线图如下所示：

![1739364384538](D:\Tencent files\MobileFile\1739364384538.jpg)

​	来自主机的片选信号用于选择从机，它通常是一个**低电平有效信号**，拉高时从机与*SPI*总线断开连接。当使用多个从机时，主机需要为每个从机提供单独的片选信号。

​	*MOSI*和*MISO*是数据信号线，*MOSI*是主机发送从机接收的数据线，*MISO*是主机接收从机发送的数据线。

##### 2.3.3. SPI协议层

##### 2.3.3.1. SPI数据传输/数据交换

​	*MOSI*、*MISO*、*SPI*主机和*SPI*从机内部的数据寄存器构成一个数据串行传输的环路，在时钟控制下实现数据的环形传输。如下图所示：

![image-20250212220431724](C:\Users\JetzeyChen\AppData\Roaming\Typora\typora-user-images\image-20250212220431724.png)

​	*SPI* 设备间的数据传输之所以又被称为**数据交换**，**是因为 *SPI* 协议规定一个 *SPI* 设备不能在数据通信过程中仅仅只充当一个 "发送者(*Transmitter*)" 或者 "接收者(*Receiver*)"**。在每个 *Clock* 周期内，***SPI* 设备都会发送并接收一个 *bit* 大小的数据(**不管主设备好还是从设备**)**，相当于该设备有一个 *bit* 大小的数据被交换了。一个 *Slave* 设备要想能够接收到 *Master* 发过来的控制信号，必须在此之前能够被 *Master* 设备进行访问 (*Access*)。所以，*Master* 设备必须首先通过 *SS/CS pin* 对 *Slave* 设备进行片选, 把想要访问的 *Slave* 设备选上。 在数据传输的过程中，每次接收到的数据必须在下一次数据传输之前被采样。如果之前接收到的数据没有被读取，那么这些已经接收完成的数据将有可能会被丢弃，导致 *SPI* 物理模块最终失效。

##### 2.3.3.2. SPI时钟极性与时钟相位

​	在*SPI*通信中，主机可以选择**时钟极性**和**时钟相位**。

 1. **时钟极性**

    表示总线空闲时时钟的极性，取决于：

    *CPOL* = 0，时钟空闲电平为**低电平**，有效时为高电平；

    *CPOL* = 1，时钟空闲电平为**高电平**，有效时为低电平。

 2. **时钟相位**

    对应数据采样在第一个边沿还是第二个边沿，*CPHA* = 0，表示第一个边沿，*CPHA* = 1，表示第二个边沿。

##### 2.3.3.3. SPI模式

​	主机必须根据从机的要求选择时钟的极性和时钟相位。根据 *CPOL* 与*CPHA* 两个参数的组合，总共有 *4* 种 *SPI* 通信模式。

1. 模式*0*：*CPOL* = *0*，*CPHA* = *0*。数据在第一个上升沿采样，在后续下降沿移出。如下图所示：

   <img src="D:\Tencent files\MobileFile\1739370733396.jpg" alt="1739370733396" style="zoom: 25%;" />

2. 模式*1*：*CPOL* = *0*，*CPHA* = *1*。数据在第二个下降沿采样，在后续上升沿移出。如下图所示：

   <img src="D:\Tencent files\MobileFile\1739370733390.jpg" alt="1739370733390" style="zoom:25%;" />

3. 模式*2*：*CPOL* = *1*，*CPHA* = *0*。数据在第一个下降沿采样，在后续上升沿移出。如下图所示：

   <img src="D:\Tencent files\MobileFile\1739370733383.jpg" alt="1739370733383" style="zoom:25%;" />

4. 模式*3*：*CPOL* = *1*，*CPHA* = *1*。数据在第二个上升沿采样，在后续下降沿移出。如下图所示：

   <img src="D:\Tencent files\MobileFile\1739370733375.jpg" alt="1739370733375" style="zoom:25%;" />

### 2.4. TCP/IP



### 2.5. USB-FS



### 2.6. MODBUS



### 2.7. CAN



### 2.8. Ethernet



[^1]:重复开始信号：在结束时不给出结束信号，而以一个时钟周期内再给出开始信号。

[^2]: Master Out Slave In
[^3]:Master In Slave Out.
[^4]:Chip Select /Slave Select（N表示低电平有效）.
[^5]:Recommended Standard 建议标准。
[^6]:
[^7]:Transistor-Transistor Logic 晶体管-晶体管逻辑
[^8]:

