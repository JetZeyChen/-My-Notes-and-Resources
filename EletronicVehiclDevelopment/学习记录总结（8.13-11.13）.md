# 一、电车电控总体认知

​	目前公司主要经营的业务为 *MCU* 主驱，辅驱控制器，以及 *PDU* / *DCDC* / *EPS* 等多合一控制器。对于实际项目开发需要对该电控单元 *ECU* 具有深刻的认知，下面是对各 *ECU* 的一个介绍。

> 注：这里的多合一控制器，是将多个原本独立的 *ECU* 进行的一个结构的整合，将其容纳在同一个外观结构中，同时共用一些接线。目的是减少占用整车空间，以及减少线束的分布，有利于车厂安装布线。但是其内部仍然是多个独立的微控制器 *MCU* 构成的主控板进行相互独立的控制逻辑，目前还没有方案实现多个 *ECU* 整合为一个 *ECU* 的情况。但是上述整合多个 *ECU* ，也是目前的一个研究方向，其课题大致为融合感知相关。

## 电控器件分类以及功能

### 控制系统

#### VCU

​	*VCU*——*Vehicle Control Unit*  整车控制器单元，其是整车信息流的中枢系统，也称为新能源电车的”大脑“。负责接收所有其他 *ECU* 传递的 *CAN* 报文信息，然后通过设定控制策略，进行决策、判断并且下发执行命令。其目的为：安全，可靠，高效地控制整车运行，预测驾驶员的行为，在安全的基础上提供舒适的性能。

> 在目前的主流 *VCU* 应用中， *VCU* 存在两路 *CAN* 通讯，分别为整车 *CAN* 以及动力 *CAN* 。这样配置的目的主要如下：
>
> 1. 合理分配带宽：电车上会存在非常多的 *ECU* ，且每个 *ECU* 需要发送的报文纷繁复杂，那么就需要合理分配带宽，避免总线一直满载，减少丢帧的情况；
> 2. 利于管理节点：整车 *CAN* 网络就连接各个非动力驱动相关的节点；动力 *CAN* 网络就连接各个 *MCU* 、*EPS* 等动力驱动相关的节点；且通常两个网络的波特率存在差异，动力 *CAN* 的实时性通常要求较高，*Baud*通常为 *500K*，整车 *CAN* 的实时性要求通常会低一些，*Baud* 通常为 *250K*，实际要以项目需求为准。

#### MCU

​	*MCU —— Motor Control Unit*  电机控制器单元，其用于控制各种电机的运行。目前市面上最常用的即为无刷直流电机 *BLDC*，其控制方式简单且运行稳定；在无刷直流电机中，新能源电车普遍使用永磁同步电机 *PMSM*。*MCU* 的目的是：保证电机寿命的前提下，高效、稳定地控制电机的运行。

​	在业内，*MCU* 常指用于驱动汽车运行的电机控制器，也称为主要驱动控制器。

#### EPS

​	*EPS —— Electrical Power Steering*  电动助力转向，其本质也为 *MCU*，但是专门用于转向控制的 *MCU*，通常也称为辅助电机控制。*EPS* 功能的电机主要为产生液压的泵电机，包括：水泵，油泵等。该类电机主要使用转速控制（在电机控制模式中有：转矩控制——目标输出固定的转矩，而不考虑转速的波动；转速控制——目标输出固定的转速，而不考虑转矩的波动）。

​	使用转速控的原因：（液压泵的原理：在密闭容器中的液体的体积的变化就会产生变化的气压，压力大小由阻力负载决定，阻力越大，压力越大）泵的排量V：电机内部扇叶转一圈固定的液体流动体积固定，即多少 *ml/round*；泵的流量 *Q*：单位时间内排除的油液体积（*L/min*），*Q* = *V* * *n*。只有转速稳定，那么才会产生固定的流量，与外部负载产生稳定的压力。



### 能量系统

#### BMS

​	*Battery Management System*  电池管理系统，电池的监视着。用于检测动力锂电池组的每一个电芯的电压，温度，电流；保护电池过充，过放，过温，过流和短路；使各个电池报电芯电压保持一致，延长寿命；将电池状况（*SOC Status of Charge, SOH Status of Health*）返回到 *VCU*。

​	其主要涉及算法：*SOC / SOH* 估算算法，以及电池均衡策略。

#### PDU

​	*Power Distribution Unit*  能量分配单元/高压（直流）配电盒，将高压电分配到各个（高压系统中）的高压部件（*MCU*，*DCDC*，*AC*，*PTC* 等）。主要接收来自 *VCU / BMS* 的上高压/下高压指令，控制接触器的吸合与断开。电车系统的整个高压回路能量流由 *PDU* 控制。

​	其内部集成的器件有，预充电路——用于在给整车上高压时，提供一个预充保护功能，避免直接上高压带来强大的瞬间冲击电流烧毁元器件，或者导致接触器烧毁粘连，在预充电路上增加一个充电电阻，使充电过程有一个过程；各种接触器（主正/负接触器，*DC* 接触器，*MCU* 接触器，*PTC* 接触器，*AC* 接触器等）；熔断器，在串联在各个接触器所在的高压线路中，提供了过流保护功能。

> 虽然 *PDU* 与 *BMS* 均为电车高压总线拓扑的节点，但是两者并没有包含与被包含的关系， *BMS* 主要对 *Power Battery* 动力电池进行一个实时诊断检测，*PDU* 是一个控制执行器件，对动力电池输出后的能量进行一个通断，进而对能量进行分配。在一些实际项目中，也可以根据需求，将二者功能整合在一起。

#### DCDC

​	*Direct Current to Direct Current Converter* 直流/直流转换器，在汽车电控中，为高压直流/低压直流转换器。

​	动力电池输出的电压较高，通常为 *100V~400V* 甚至是 *800V*，不能被车辆中的用电器直接使用，因此需要降压型的 *DC / DC* 变换器将高压直流电转换为恒定的 *12V*、*14V*、*28V* 或 *48V* 低压直流电，才能为灯光照明、电动车窗、刮水器、除霜器、仪表系统、娱乐系统、电池管理系统、驾驶控制、电动座椅、喇叭等用电器供电或给蓄电池充电。由于整车用电器消耗功率较大而所需电压较低，因此 *DC / DC* 变换器具有低电压、高电流的特点。

​	*DCDC* 联系着整车的高压电路以及低压电路，在车辆未上高压时，*DCDC* 未使能，此时汽车上低压电路的所有的 *ECU* 使用的低压电均来自蓄电池（*24V / 12V*），所以如果长时间使用蓄电池供电，而不上高压通过 *DCDC* 给蓄电池充电，就会出现蓄电池馈电无法启动的情况。当车辆正常上高压，那么就需要确保 *DCDC* 模块正常启动，将高压直流转为低压直流提供给各个 *ECU* ，并且给蓄电池充电。



#### OBC

​	*On-Board Charge* 车载充电机，作用是将外部高压交流电转换为电池可以存储的高压直流电。

​	充电分为快充以及慢充：快充，是将直接从外部获取高压直流电输入到动力电池；慢充，则是上述通过 *OBC* 将高压交流先转换成高压直流在输入到动力电池。



### 温度系统

#### TMS

​	*Thermal Management System* 热管理系统，是控制车辆各种器件环境温度平衡的系统，使各器件都能处在最佳的工作环境温度中。

​	电池热管理系统 *BTMS*，是保障电池安全、延长续航里程、提升乘坐舒适性的核心系统。与传统燃油车不同，电动车没有发动机余热可用，且电池、电机等部件对温度敏感（电池最佳工作温度范围为 *20-40℃* ），因此需要更复杂的热管理方案。



#### PTC

​	*PTC ( Positive Temperature Coefficient )* 的作用就是制热。本质是一种加热电阻器件，在其通上电流就会产生热量。*PTC* 加热也可以分为多种加热功能，空调暖风 *PTC*，座椅加热 *PTC*，电池包预热 *PTC*等。

​	传统车上空调暖风系统的热源是引入发动机冷却后的冷却液的热量，这个在新能源车上是不存在的，因此需要专门的制热装置，这个装置被称为空调 *PTC*。当低温的时候，电池包需要一定的热量才能正常工作，这时候需要电池包 *PTC* 给电池包进行预热。



## 电机控制相关原理简述

​	在工程项目种，目前市场主流的电机均为，直流无刷电机BLDC，特点在于，效率高，且性能稳定可靠。然后在直流无刷电机中，使用最多的就是永磁同步电机PMSM。再电机控制方面，电机是由三相逆变器输出的三相电压/三相电流驱动的，该三相电流会流经定子绕组产生相应的旋转磁场，然后转子在磁场的作用下进行转动。

​	由于为了使得控制器更加方便对电机进行一个控制，使用SVPWM技术，对电机产生的三相电压进行一个精确的控制，达到比较精细的角度控制。然后其中涉及两个关键的电流变量Iq、Id。Iq是转矩分量，其与转子垂直，产生转矩；Id是励磁分量，其与转子平行，产生的是磁场。

​	对于电机的控制，最终就等于对两个电流分量的控制。如果要输出扭矩，加速电机的转速，就需要提供一个较大的Iq驱动电机。电机的特点：**即是电动机也是发电机**。当转速提升的时候，反电动势也会增强。所有在高速的电机中，需要加入Id分量来对反电动势进行削弱，进而提高电机的最高稳定转速。而这个过程称为——弱磁控制。

![img](https://picx.zhimg.com/v2-6779b0f15b8c77d23281b9c946dd2791_1440w.jpg)



## 工程实践方法

​	由于电机本身内部以及外部环境的一些因素，在工程实践中，需要对使用的电机进行标定，获取电机在固定测试环境下的一个表现情况，记录下相关的，输出电流，输出转矩，输出转速之间的关系，在后续程序设计中，需要使用这些数据作为一个参考值，对其他情况进行一个校准，此方法为 *LUT*，*Look up table* 查表法。

​	这便是一个较为使用的系统特性测量方式，通过多次重复测试，验证参数的可靠性。



## 整车高压拓扑

​	吉鑫翔多合一的高压电气架构如下：

<img src="C:\Users\10637\AppData\Roaming\Typora\typora-user-images\image-20251024110149179.png" alt="image-20251024110149179" style="zoom:67%;" />



# 二、Simulink 仿真与MATLAB 编程

## Simulink模型构建方法

### 	明确建模目的

​		用于控制器算法开发/系统性能预测/安全边界分析，还需考虑参数精度要求等。

### 	四步建模法

​						![image-20250816143645270](C:\Users\10637\AppData\Roaming\Typora\typora-user-images\image-20250816143645270.png)

​		1.机理分析/第一性原理

​			物理定理锚定，确认数学表达式

​		2.结构简化

​			降阶简化，例如：非线性系统可以通过分段线性进行拟合。

​		3.参数辨识

​			这里便是上述Q1问题中的参数获取方法。

​		4.验证迭代

​			闭环矫正，不断进行上述2/3步骤以达到模型与实际系统高度吻合。



## Simulink仿真步骤

​	仿真步骤流程图如下所示：

​					![image-20250816133305616](C:\Users\10637\AppData\Roaming\Typora\typora-user-images\image-20250816133305616.png)		

### 数学建模

​	这是 *Simulink* 最关键的一步，如何对所仿真的物理对象进行抽象数学模型建模，将其关键因素提取，构建数学模型，包含公式、方程组等数学表达式。使用数学语言描述物理对象。

### 控制器设计

​	许多仿真对象都具有一定的控制结果，如PID控制器，其在温控系统中就十分常用。*Simulink* 库中可能没有现成可用的控制器，就需要手动搭建。

### 模型搭建

​	在 *Simulink* 中搭建仿真模型，需要根据数学建模进行。

### 参数调试

​	在开始仿真之前一些系统模型需要设定一些初始状态，初始值，以及一些参数的初始标定。在仿真的过程中也可以进行实时参数调整。

### 动态仿真

​	在构建好仿真模型之后，运行动态仿真可以实时观察仿真结果以及调整修改参数，查看系统仿真结果的变化。

### 结果分析

​	通过仿真结果分析参数，得出最有参数解，然后进行硬件上机验证。



## Simulink 在工程实践中的潜能

​	*Simulink*  是  *MATLAB*  环境下的**多域动态系统建模与仿真平台**，广泛应用于汽车控制、电力电子、航空航天等领域的算法开发与**硬件在环（*HIL*）**测试。

>*HIL（Hardware in the Loop）*硬件在环，是一种将**真实控制器**与**虚拟被控对象模型**实时连接的测试方法，广泛应用于汽车、航空航天等领域。其核心价值在于**在实验室环境下安全、高效地验证控制系统的可靠性与鲁棒性**。

​	且 *Simulink* 具有强大的代码生成功能，并且具有 *TI*  硬件支持包，只需将 *TI*  的硬件设备支持包导入，然后选择正确的设备配置，就可以根据构建的模型一键生成 *C* 语言代码，这在软件的研发阶段是十分强大的一个工具，可以减少对一些代码的编写，研发人员只需要确保逻辑的正确性即可。

​	*Simulink* 是一个十分强大的数学工具，在目前的电车等行业中，如果能够熟练使用，并且其具有算法开发验证的工具链，那么对于研发人员提高算法设计能力也是十分有力的工具。

# 三、各软件程序的使用

## CCS

​	*CCS* 是 *TI* 官方的 *MCU* 软件开发集成 *IDE* ，其目前最新版本已经更新到 *20.3.0* 版本，最新版的软件引擎使用的是与 *VSCode* 一致的引擎，其界面架构基本别无二致。

### CCS3.3

​	*CCS* 较为古早的版本，且其兼容的版本为 *WindowsXP* 系统，所有对于最新的微软系统可能会存在一些小问题。由于公司产品代码，工程建立时间较早，且使用的都是 *CCS3.3*，那么后续需要使用相关的软件目标进行项目调整后，生成 .*out* 文件就需要使用 *CCS3.3*。

<img src="C:\Users\10637\AppData\Roaming\Typora\typora-user-images\image-20251023165419549.png" alt="image-20251023165419549" style="zoom:33%;" />

### CCS12.0

​	*CCS* 比较经典的版本，使用该版本的场景为，目前公司内 *DCDC* 项目的构建需要使用该版本的 *IDE* 环境。该版本 *IDE* 还支持导入 *CCS3.3* 的工程项目，有一个向下兼容的功能，目前还没有验证。

<img src="C:\Users\10637\AppData\Roaming\Typora\typora-user-images\image-20251023165645140.png" alt="image-20251023165645140" style="zoom:33%;" />

### CCS20.0

​	*CCS* 的最新版本，且外观界面与 *VSCode* 极其相似，对于熟悉 *VSCode* 的用户来说十分友好，且易上手。目前开发 *TMS320F280049c* 芯片的 *VCU* 项目可以使用该 *IDE* ，且配合上仿真器可以进行代码的调试，可以方便检查代码 *BUG* 。

<img src="C:\Users\10637\AppData\Roaming\Typora\typora-user-images\image-20251023165738077.png" alt="image-20251023165738077" style="zoom: 33%;" />

## 研发用上位机软件

### 程序烧录软件

​	该上位机软件可以烧录 *MCU*、*EPS*、*PDU* 等节点的程序，在打开 *CAN* 之后，如果扫描失败。注意检查，*CAN*通道以及波特率是否正确。还有就是目前肯能存在一个 *BUG*，就是 *CAN* 卡同时接两路，但是只选择其中一路通道，但是也是无法扫描；只接一路，同一个通道，可以正确扫描。

​								<img src="C:\Users\10637\AppData\Roaming\Typora\typora-user-images\image-20251023171339870.png" alt="image-20251023171339870" style="zoom: 50%;" />

​	烧录时需要注意：

1.  如果烧录的节点与目标节点一致，但是程序存在性能层方面的差异，需要强制烧录；
2. 如果烧录的节点与目标节点不一致，选择强制烧录，且注意查看站点是否为目标节点，如果不为目标节点是无法进行通信的，正确选择之后，会弹出是否强制烧录对话框，回复 *Y* 即可；
3. 如果遇到烧录卡住，或者烧录失败的情况，可以多次尝试，多次尝试未果，则需要判断是否为软件 *bug*。

### VCU烧录软件

​	由于 *VCU* 使用的第三代 *TI* *C2000* 实时控制器，其芯片可能存在一些差异。所以需要单独使用一个上位机软件进行 *VCU* 程序的刷写。

<img src="C:\Users\10637\AppData\Roaming\Typora\typora-user-images\image-20251023173327812.png" alt="image-20251023173327812" style="zoom: 50%;" />

​	注意刷写时，一定要载入对应的 *FlashAPI* 文件，然后再加载需要烧录的 .*out *程序文件。

### DCDC烧录软件

​	由于 *DCDC* 软件是由欣锐设计开发的，所以上位机烧录软件也是独立。点击连接即打开 *CAN* 卡，连接 *CAN* 网络，如果显示连接失败，请检查接线以及 *CAN* 通道与波特率。

> ​	目前使用 *12.0* 版本烧录软件是没有问题的，但是新版的 *12.2* 提供了一个生成校验文件的功能，直接导入原生的 .*bin* 文件会提示校验文件出错，但是选择将原生文件进行一个生成校验文件的操作后，将生成的 .*bin* 文件导入就是正确的。目前没有查看到 *12.2* 的操作指南，上述操作正确性待验证。

​									<img src="C:\Users\10637\AppData\Roaming\Typora\typora-user-images\image-20251023173454438.png" alt="image-20251023173454438" style="zoom: 50%;" />

​	*DCDC* 烧录与其他程序烧录不同的是，其烧录的程序是.*bin* 文件，点击左下角打开文件，加载烧录文件，出现解析正确即可，然后点击右下角发送，等待发送完毕，即烧录完成。完成后可以点击，开发模式，可以进行一个软件信息的读取，读取完毕之后会弹窗显示相关信息。

### 电机调谐软件

​	电机调谐分为高速和低速两个版本，请注意相关程序的匹配，否则无法整车进行调谐。参数界面下的参数，与程序中的参数列表是一一对应的。右侧悬浮的快速面板，可以查看实时刷新的变量，以及对一些变量进行快速赋值。

​	其中右侧面板的调谐：0-无调谐；1-未知；2-未知；3-未知；4-未知；5-静态调谐；6-动态调谐。

<img src="C:\Users\10637\AppData\Roaming\Typora\typora-user-images\image-20251023172459440.png" alt="image-20251023172459440" style="zoom: 33%;" />

​	注意上图中，左下角的"写 *EEPROM* "注意判断是否要勾上，否则写入的时候不会写入 *EEPROM* ，当重新上电之后也只会是原来的参数。通常都勾选，避免参数无响应。

​	该软件自带波形显示功能，需要在波形界面点击运行，此时快速面板的参数刷写将会失效，其实时运行显示目前肯存在一些问题，非常不便。当结束运行之后，选择保存波形文件，然后重新导入后查看即可。想要更加全面的分析，注意要使用 *CANoe* 分析 *asc* 文件波形数据。

### UniFlash

​	该软件是 *TI* 官方提供的烧录 *TI* 芯片的 *Flash* 的软件，在研发过程中，需要使用该软件来烧录芯片的*Bootloader* 引导程序。且该软件提供，内存读取的功能，可以从指定 *Flash* 地址中读取数据。

<img src="C:\Users\10637\AppData\Roaming\Typora\typora-user-images\image-20251023172412259.png" alt="image-20251023172412259" style="zoom: 50%;" />

## CAN分析

​	*PC* 与 *CAN* 网络连接，并且能够采集 *CAN* 网络数据的设备，被称为 *CAN* 卡。该设备将 *CAN* 网络的差分信号转换 *USB* 信号传递到 *PC* 中。正如 *UART* 串口通信一样，也具有类似串口调试助手的 *CAN* 数据分析的上位机软件。分别是 *ZLG*  国产的 *ZCANPRO* ，以及 *Vector CANoe*  国际认证专业软件。

> 使用 *CAN* 卡安装驱动时，需要注意， *Win11* 系统对驱动修改内核有限制，需要关闭内核隔离才可以正常安装驱动。

​	对于 *CAN* 通信而言，确定了其物理层协议版本一致，那么硬件驱动层就只需要实现物理层就可以了。但是 *CAN* 存在许多的应用层协议，应用层协议的不同实际上影响的就只是通信的功能分布。应用层协议有如下：

* *UDS*

### ZCANPRO

​	该软件是与 *ZLG CAN* 卡设备匹配的上位机软件，可以实时查看 *CAN* 卡所接 *CAN* 网络的数据帧。其中有一些较为实用的功能：

* *DBC* 视图——加载已经配置号的 .*dbc* 文件，就可以将当前的原始帧数据，解析成 *dbc* 文件定义的格式，可以清晰明了判断数据值是否存在异常；
* *DBC* 发送——配合 *DBC* 视图功能，可以实现收发数据的测试，验证 *CAN* 通信是否存在问题；
* 实施保存——该功能可以实时保存当前接收到的CAN数据帧原始数据到 .*asc* 格式的文件中，该文件可以被*CANoe* 打开识别，进行后续的分析。

### Vector CANoe

* *DBC —— CANoe* 的一个实用且强大的工具，因为每一个不同的项目需求都有不同的协议格式，所有为了更方便分析 *CAN* 报文数据，需要一个查找表去将原始 *CAN* 数据转换为，应用层需要的数据格式，这样的文件就是*DBC*文件。

  > 构建 *DBC* 文件步骤如下：
  >
  > 1. 打开 *CANoe*，然后选择 *Tool* 栏下的 *CANdb++ Editor*
  >
  >    <img src="C:\Users\10637\AppData\Roaming\Typora\typora-user-images\image-20251023132725257.png" alt="image-20251023132725257" style="zoom: 67%;" />
  >
  > 2. 然后弹出一个模板选择界面，这里选择标准 *CAN* 模板，然后给定 *dbc* 文件名称
  >
  >    <img src="C:\Users\10637\AppData\Roaming\Typora\typora-user-images\image-20251023133243616.png" alt="image-20251023133243616" style="zoom: 67%;" />
  >
  > 3. 右键添加信号，信号为每一帧报文下数据域的数据单元
  >
  >    ​	右键 *Signals*  -->  *New*  新建信号，然后会弹出信号编辑界面。
  >
  >    <img src="C:\Users\10637\AppData\Roaming\Typora\typora-user-images\image-20251023133548662.png" alt="image-20251023133548662" style="zoom: 50%;" />
  >
  >    ​	我们需要根据定义好的应用层协议文件去定义相关的信号，包括信号名称，长度，字节序（*CAN* 帧格式定义了两种字节序格式，分别为 *Intel* 小端序，*Motorola* 大端序）,数据类型，缩放因子还有偏移量。最下方的值表可以给该信号的值提供定义，值表的建立在步骤5。
  >
  > 4. 右键添加帧，帧就对应协议中的一帧报文
  >
  >    ​	右键*Messages*  --> *New* 新建消息，然后会弹出消息编辑界面。
  >
  >    <img src="C:\Users\10637\AppData\Roaming\Typora\typora-user-images\image-20251023134427354.png" alt="image-20251023134427354" style="zoom:50%;" />
  >
  >    ​	在定义界面，我们需要根据协议，给定消息名称，帧类型（扩展/标准），*ID* 号；
  >
  >    ​	在 *Signals* 界面，可以给该消息添加信号，然后在 *Layout* 界面，查看信号再消息的数据域如何分布。
  >
  >    <img src="C:\Users\10637\AppData\Roaming\Typora\typora-user-images\image-20251023134651823.png" alt="image-20251023134651823" style="zoom: 50%;" />
  >
  >    > 注：一定要保证消息的分布要与协议需求文件定义一致，且不能超过 *64Bits*。
  >
  > 5. 右键添加值表，其作用类似于 *C* 语言的枚举类型，给每一个数值提供一个定义
  >
  >    ​	上方导航栏 *View* -->  *Value Tables* 打开值表界面。
  >
  >    <img src="C:\Users\10637\AppData\Roaming\Typora\typora-user-images\image-20251023134902007.png" alt="image-20251023134902007" style="zoom:50%;" />
  >
  >    ​	然后右键，点击 *New* 新增值表，然后弹出值表界面
  >
  >    <img src="C:\Users\10637\AppData\Roaming\Typora\typora-user-images\image-20251023135938927.png" alt="image-20251023135938927" style="zoom: 50%;" />
  >
  >    ​	在值定义栏下，点击 *Add* 添加定义，如上图所示，*0*代表这 *Stop*，那么在报文解析的时候就会显示*Stop* 字符而不是数字 *0*，有利于我们的解读。

* *Graphics* ——载入 *asc* 文件，可以将数据可视化，更加方便的利于查看分析 *CAN* 通信逻辑，对于项目故障分析排查十分有用。

  > 分析 *CAN* 数据波形步骤如下：
  >
  > 1. 打开 *CANoe*，点击上方导航栏的 *Analysis*，然后点击 *Measurement*；
  >
  >    <img src="C:\Users\10637\AppData\Roaming\Typora\typora-user-images\image-20251023164552319.png" alt="image-20251023164552319" style="zoom: 33%;" />
  >
  >    ​	然后双击左边的开关可以切换为 *Offline* 或者 *Online* 模式，载入 *asc* 文件是 *Offline* 模式。然后双击左边的文件夹导入相应的 .*asc *文件即可。
  >
  > 2. 点击上方导航栏 *Simulation*，然后点击一个图标（不是下方文字）；
  >
  >    <img src="C:\Users\10637\AppData\Roaming\Typora\typora-user-images\image-20251023164806760.png" alt="image-20251023164806760" style="zoom:33%;" />
  >
  >    ​	进入该界面后，看右侧侧边栏，分别在 *Databases* 下加载相应的 .*dbc* 文件，然后再*Channels*下选择相对应的通道，注意：通道选错了是没有输出波形的！
  >
  > 3. 然后返回 *Analysis* 界面；
  >
  >    <img src="C:\Users\10637\AppData\Roaming\Typora\typora-user-images\image-20251023165024998.png" alt="image-20251023165024998" style="zoom:50%;" />
  >
  >    ​	点击该图标打开，波形显示界面。
  >
  > 4. 点击左上角的 *Start* 图标，生成波形。
  >
  >    <img src="C:\Users\10637\AppData\Roaming\Typora\typora-user-images\image-20251023165107686.png" alt="image-20251023165107686" style="zoom:50%;" />

​	*CANoe* 还有许多非常强大的功能待发掘，使用 *Vector* 官方的 *CAN* 卡设备可以实时分析数据，且可以判断有无错误帧等功能。

# 四、项目开发流程以及注意事项

## 项目前期

​	项目前期指，从接收到项目开始，根据技术协议等相关需求文件，对该项目的有一个总体的认知。然后软件方面，重要的两个文件：《软硬件对接表》、《通信协议》

1. 软硬件对接表

   ​	软硬件对接表，上面会列出硬件变更后，软件需要注意的一些地方，相应的软件方面也要进行一个同步的更新。

2. 通信协议

   ​	通信协议，便是项目相关的CAN通信协议，程序软件通信则根据通信协议定义进行匹配变更。

3. 技术协议

   ​	里面包含项目相关的所有基本资料，包含控制器参数，电机基本参数，外壳尺寸，以及低压接口线束定义等相关标准。

​	在前期的过程中，需要及时与项目经理沟通，确认软件提供初版程序的时间，以及请求提供测试的样机，给足够的时间进行初步的测试验证，避免后续现场出现一些初级问题。

> 注：初版程序，通常需要匹配的参数如下：
>
> * 基础参数：
>   1. **命令源**：*0* - 后台控制；
>   2. **载波频率**，**最大频率**，**限制频率**的设置目前还没有确定；
>   3. **控制器机型**是性能层控制时影响的死区补偿时间相关，一般跟性能层匹配不用动；
>   4. **母线电压等级**，需要与控制器的输入电压范围匹配，主要是最大输入电压，其值为 *0* 时，过压点的基准电压为 *450*；其值为 *1* 时，过压点的基准电压为 *750*；通常情况下 *2* 用不到。
>   5. **UV两相采样增益**，目前的控制器三相霍尔采样，一般只采 *UW* 两相。然后该参数影响控制器的三相输出电流 *U* 相与 *V* 相的值，*Iv* 小了，那就把参数调小；*Iv* 大了，就把该参数调大。***UW* 两相采样增益**同理，其计算基准都是 *U* 相电流。
>   6. **母线电压矫正系数**，为了让检测的母线电压与实际电压一致，提供的矫正系数；
>   7. **电流矫正系数**、**控制器额定电流**，该参数是通过计算得出的值（电流矫正系数通常先确定好，且常为*100%*），如果三相霍尔的量程为*400A*，**控制器额定电流** = *400A* / *2*  * *0.707* **电流矫正系数**。
>   8. **软件设置过流点**，该值用于判断过流的阈值，通常为控制器峰值电流大一些的值。
> * 电机参数：
>   1. 电机基本参数，就是需要与《技术协议》一致的参数进行设置即可。
>   2. **电机温度传感器类型**：*NTC* 类型为两位数-*30*，匹配通道 *1*；*PT* 类型为个位数，匹配通道 *0*；
> * 速度控制:
>   1. **目标频率源**：*0*；
>   2. **设定目标频率**：*50~80%*；
> * 转矩控制:
>   1. **转矩指令源**：*0*；
>   2. **目标转矩设定**：*50~80%*；
>   3. **控制器温度类型设置**：*0/1* 分别匹配两个不同的 *NTC* 电压温度表，旧模板通常为 *0*。
> * 故障保护：
>   1. **欠压点**：为百分比%，且该值会在处理过程中乘以 *2*。等效于基准电压为200V的百分比值，最后计算出的值为《技术协议》中，控制器的欠压点；
>   2. **过压点**：为百分比%，且其基准与**母线电压等级**相关；
>   3. **过载电流给定**：通常为控制的峰值输出电流；
>   4. **控制器过温点**、**控制器过热预警点**：匹配《技术协议》；
>   5. **电机过温点**、**电机过热预警点**：通常为 *85℃、78℃*。

## 测试

​	测试，通常为台架测试，在台架环境中，存在一个对托电机，以及配测电机。我们的控制连接控制配测电机，对托电机做一个辅助带动的作用。在获取到测试样机之后，需要安装台架测试环境。然后对电机控制器的进行初步的测试，比如：VF控制下运行，后台反馈数据是否正常；电机采样的传感器数据是否正常；电机能否正常开关管等。

​	在装机完成之后，发货前，需要由测试人员进行工装测试。工装测试过程，会有专门的测试程序，对电机的一些参数进行调整，然后查看控制器的输出是否合格。这一步过程就可能出现一些问题，此时软件协同整改。

## 跟进

​	

## 确认交付

# 五、程序修改以及测试验证

​	由于公司软件方面，已经打好坚实的基础，许多程序都有相应的模板可以使用，只需要根据不同项目，对于功能层面的不同需求进行修改调整，然后再根据电机标定的数据作为一个标准，对电机的性能进行一个优化调节，整体软件项目开发大致就是这么一个流程。

​	通过使用不同的软件模板，将程序修改为与需求相对应的软件程序，可以提升一个对项目开发的理解程度，以及对程序的理解。并且可以加深对相关 *ECU* 的功能、作用的认知。

​	以下测试验证，均使用的是 *TCF* 电动叉车实现。对于所有项目，首先必须要明确项目的需求是什么，这样跟据需求定位代码，对代码进行一个调整或者功能的添加。根据获取到的需求文件，需求信息，进行一个整理分析，然后再确定代码的实现过程。

> 注：如果再测试过程中，报故障，那么可以查看故障指南，查看对应故障的产生可能原因，以及一些常用的解决方案。但是有一些故障，可能需要具体问题具体分析，做好相关记录。

## VCU硬件抽象层开发以及验证

​	通过学习芯片使用手册，学习了 *TMS320F28004x* 系列的芯片外设，主要学习了 *CAN* 外设的使用，根据官方的例程构建了以中断方式的 *CAN* 收发通信测试。然后再此基础上，根据 *JXX VCU* 项目需求构建了 *CAN* 报文收发架构，测试后结果为复用邮箱无效，且发送存在延时问题。

> 针对上述问题，目前总结的方法为
>
> 1. 发送周期短的消息，应该分配优先级更低的邮箱；
> 2. 优先级高的消息，应该使用中断方式；
> 3. 大量低优先级的消息可以使用 *FIFO* 接收；

​	通过这个学习过程，深刻理解了 *CAN* 外设驱动的编写，以及应用层协议代码的一个构建。对后续其他相关*CAN* 协议代码调整有一个经验基础。

### 修改指南

1. 将原程序作为模板，一次小模块的调整，这样避免大规模变更导致的一些错误问题，不利于问题的分析与排查；
2. 对原程序的逻辑架构进行优化重构，需要进行测试验证，避免反向优化。

### 测试验证

​	将先后两个程序进行对比，查看 *CAN* 报文收发时序是否有较大差异，对于 *VCU* 一定要保证 *CAN* 报文的实时处理。

## EPS程序修改以及验证

### 修改指南

1. 在修改电机基本参数时一定要明确，该电机性能层是高速，还是低速；可以通过参数*6*最大频率进行判断

   <img src="C:\Users\10637\AppData\Roaming\Typora\typora-user-images\image-20251023152426278.png" alt="image-20251023152426278" style="zoom:50%;" />

   ​	如上图所示，如果其下限值为*5000*，则该程序为高速程序，频率的单位为*0.1Hz*；如果为*50000*，则是低速程序，频率单位为*0.01Hz*。

   > 注：由于*U16*数据的最大值为*65535*，对于*0.01Hz*为单位，其频率最大值为*655Hz*，一些电机可能会跑到*700~800Hz*，所以需要牺牲一些频率精度，获取更高的频率范围。

2. 电机铭牌上的额定数据一定要保持一致；

   > 注：因为参数并没有独立给定一个电机极对数的参数，那么在程序中，电机极对数相关的使用是在电机频率以及电机转速的转换上。根据转换公式可以确定，额定频率跟额定转速之间的比值就等于这个转换系数，只有确保额定频率与额定转速是正确的，那么才能正确的换算。

3. 参数*30*温度传感器类型，其不仅要确定温度传感器类型，还需要匹配对应的 *ADC* 转换通道；

   > 注：该参数每个数位代表一个通道，比如*30*，十位代表的是：*1*通道传感器类型为*3*；各位代表的是：*0*通道无传感器。以此类推。

4. 程序的逻辑以及数据流一定要确保清晰，这就必须确保功能层没有问题，可以正常上高压；

5. 参数*8*：电机转向以及参数*27*编码器相序都必须确保正确，否则电机无法正确运作。

### 测试验证

​	对于 *EPS* 程序，其电机控制模式为有旋变传感器的闭环控制，且控制目标为转速。有传感器说明，其对于转速的精度是由要求的；还有一种是无旋变传感器的开环控制，转子的位置是通过一些变量估算的，那么就说明该程序运行时间输出存在一定的误差。

#### 电机调谐

​	对于一个电机程序的调试，首先就是要对电机的一些基本参数进行一个调试。在调谐之前，一定要确保上位机程序是与性能差匹配的，高速对应高速，低速对于低速，否则调谐过程会报电机传感器故障，调谐失败故障等。由于调谐是一个自学习的过程，通过一些指定的算法程序，去粗略大致的确定电机的参数。

> 注：调谐时，必定要将额定电流以及转速控上限电流指令降低，否则，过程会报过流故障！

* 静态调谐

​	静态调节主要对参数*36*、*37*和*38*进行一个整定，该过程电机不会运转，所以称为静态调谐。

​										<img src="C:\Users\10637\AppData\Roaming\Typora\typora-user-images\image-20251023155717730.png" alt="image-20251023155717730" style="zoom: 67%;" />

* 动态调谐

  ​	动态调谐主要是对参数*40，42*进行一个整定，该过程会有一段时间的电流输出，然后电机会运转起来，最后停止运行。所以称为动态调谐。

  <img src="C:\Users\10637\AppData\Roaming\Typora\typora-user-images\image-20251023155859687.png" alt="image-20251023155859687" style="zoom:67%;" />

* 零点整定

  ​	零电整定，主要针对旋变零点位置进行一个更加准确的整定，该过程需要在后台控制模式下，且参数*19*写入*7*，然后后台正常运行电机，无调谐模式。那么电机就会进行正转然后反转，最后停止的一个过程。通过该过程获取的旋变零电位置将更加精确一些。通常需要进行*2~3*次的整定进行一个对比，选取较为合理的值。

> 注：任何调谐运行过程中，都不要打断其运行，否则该调谐过程无效，除非出现了异常情况。还有，在进行所有调谐流程之后，一定要记得保存参数，避免重复调谐。

#### 转速环PI调节

​	在电机调谐完毕之后，就需要对整车进行上高压的过程测试，如果整车无法上高压，那么就需要先排查无法上高压的问题；当整车正常上高压之后（意味着功能层的代码没有问题），那么就需要来调节性能层，使得控制器更好的控制电机以达到更高效，更稳定，更舒适的驾驶体验。

​	*EPS* 的油泵转速控制，就是要实现更稳定的转速输出，即使是在外部负载变化的过程中也要紧密的跟随目标转速输出。就需要去调节转速环 *PI* 控制器的参数。其中涉及到的参数有参数*6*：最大频率、参数*63*：加速时间、参数*64*：减速时间、参数*65*：加减速时间单位、参数*66*：*KP1*、参数*67*：*KI2*、参数*68*：切换频率*1*、参数*69*：*KP2*、参数*70*：*KI2*和参数*71*：切换频率*2*。

​	其中加速时间与减速时间的作用，作用为在加速阶段，电机输出的最大频率，以及减速阶段电机输出的最大频率；且这个输出频率 = 最大频率 / （加/减速时间）。

​	*Kp* 是比例系数，可以使得系统的反应更加迅速；*Ki* 是积分作用时间，时间越长积分的影响越小，时间约短，积分影响越大。当出现超调时，就应该先降低 *Kp*，当出现稳定缓慢且有震荡时，应该增加 *Ki* 减小积分作用。

> 注：对于切换频率，其作用效果为 *0~Fc1*：使用*KP1*,*KI1*; *Fc~Fc2*：使用*KP1*,*KI1*,*KP2*,*KI2*的线性取值；*Fc2 ~ ++*：使用*KP2*,*KI2*。

​	由于目标转速之间的一个变化，所以在实际应用中，加减速时间与PI参数都可以通过策略进行切换调整，（该功能的具体实现需要在程序功能层中`void AccDecTimeCalc(void)`函数实现）以满足实际的应用需求的。在经过一段实际的测试以及调整之后，最终的效果得到了明显的优化。

#### 效果对比

​	整体效果（旧）

<img src="C:\Users\10637\AppData\Roaming\Typora\typora-user-images\image-20251016103325844.png" alt="image-20251016103325844" style="zoom: 33%;" />

​	整体效果（新）

<img src="C:\Users\10637\AppData\Roaming\Typora\typora-user-images\image-20251016104642859.png" alt="image-20251016104642859" style="zoom: 33%;" />

​	变速跟随（旧）

<img src="C:\Users\10637\AppData\Roaming\Typora\typora-user-images\image-20251016103717251.png" alt="image-20251016103717251" style="zoom:33%;" />

​	变速跟随（新）

<img src="C:\Users\10637\AppData\Roaming\Typora\typora-user-images\image-20251016105407812.png" alt="image-20251016105407812" style="zoom: 33%;" />

​	定速变载（旧）

<img src="C:\Users\10637\AppData\Roaming\Typora\typora-user-images\image-20251016103852941.png" alt="image-20251016103852941" style="zoom:33%;" />

​	定速变载（新）

<img src="C:\Users\10637\AppData\Roaming\Typora\typora-user-images\image-20251016105144236.png" alt="image-20251016105144236" style="zoom:33%;" />



## PDU程序修改以及验证

​	*PDU* 是整车高压拓扑的一个关键节点之一，其作用就是采集 *ADC* 信号，获取相关接触器前后两端的电压值，进行一个压差判断接触器状态，然后接收 *VCU* 下发的闭合指令，操作相关接触器闭合。

### 修改指南

1. 硬件电压检测点与软件采样通道的匹配；

   > ​	由于芯片 *ADC* 采样通道的限制，实际需要采样的电压点个数大于 *ADC* 采样通道数量，所以使用硬件上的一个片选，进行分时复用，将*2-3*路 *ADC* 进行复用就可以实现采集多个检测点电压。在 *ADC* 电压采样数据结构体中，存在*3*个采样电压数组。其中数组 *AdValArr2*  为*int32*类型，且其范围存在负数，所以该数组对应的是负极一组采样点。
   >
   > <img src="C:\Users\10637\AppData\Roaming\Typora\typora-user-images\image-20251021153337074.png" alt="image-20251021153337074" style="zoom: 67%;" />
   >
   > ​	数组容量 = *5*，且上述电压采样点*1~5*也总共为*5*个，所以电压采样点*1*对应数组*0*的数据，依次类推。注意查看每组采样点的参考点是多少，对于后续的判断提供参考。
   >
   > <img src="C:\Users\10637\AppData\Roaming\Typora\typora-user-images\image-20251021153459600.png" alt="image-20251021153459600" style="zoom: 50%;" />
   >
   > ​	需要注意的是，虽然有足够多的采样点，但是并不是所有的采样点的值都会使用到，比如上述*5*个采样点，仅使用了其中*3*个采样点。
   >
   > ​	正极上的采集电压点有*12*个，由数组*1*与数组*3*分别对应电压采样点*1~6，7~12*。
   >
   > <img src="C:\Users\10637\AppData\Roaming\Typora\typora-user-images\image-20251024100033479.png" alt="image-20251024100033479" style="zoom:50%;" />

2. DO硬件功能输出与功能参数表的匹配；

   > ​	由于硬线 *DO* 输出的实际功能可能存在变化，为了便于软件与硬件的匹配，软件方面在参数中提供了一个 *DO* 输出功能匹配表。 *DO* 输出的功能，将根据结构体中定义的顺序进行指定。
   >
   > <img src="C:\Users\10637\AppData\Roaming\Typora\typora-user-images\image-20251024101104963.png" alt="image-20251024101104963" style="zoom:67%;" />
   >
   > ​	该结构体声明功能必须与最终的DO处理函数指针表相匹配，比如： bit 0 对应的是 无功能，那么其对于的函数为DoFRsvd()，该调用函数将进行默认输出低电平处理；bit1 对应 预充接触器，那么DoF1()函数则必须是对预充接触器的处理，否则就会错配。
   >
   > <img src="C:\Users\10637\AppData\Roaming\Typora\typora-user-images\image-20251024101601195.png" alt="image-20251024101601195" style="zoom: 50%;" />
   >
   > ​	*do* 功能函数指针表与结构体匹配了之后，在参数 *DO* 输出列表中，再与硬件 *DO* 输出根据需求的功能进行一一匹配即可。其中，参数*140*对应硬线 *DO1*，以此类推，我们只需要将 *DO1* 对应的功能号写入即可，比如当前 *DO1* 的功能号为*3*，*3*对应的是 *DoF3*，其是主接触器 *DO* 处理。
   >
   > <img src="C:\Users\10637\AppData\Roaming\Typora\typora-user-images\image-20251024101754540.png" alt="image-20251024101754540" style="zoom:67%;" />

3. 有独立预充控制命令与无独立预充控制命令的情况；

   > 注：在一些项目中，存在独立的预充接触器控制命令，那么就根据指令动作即可；如果没有预充接触器命令，那么需要进行自动预充处理，即在接收主接触器吸合命令时，需要自动先闭合预充，然后预充完成吸合主接，然后断开预充的这么一个过程。

4. 电压阈值判断法，负极接触器前端电压参考点选择；

   > 对于负极的接触器而言，其前端参看电压既可以选择主负前端，也可以选择主正前端，两者在电池电压稳定输出的情况下是相反数，实际应用中仅有微小波动，注意数值的符号即可。

5. 反馈接触器状态报文以及接收 *VCU* 命令报文处理。

### 测试验证

#### 测试过程

1. 首先，第一次上高压电时，*DCDC* 正常输出 *14V*，但是 *VCU* 没有输出 *Ready* 信号，采集 *CAN* 报文解析得知，预充接触器在主接吸合之后，没有断开；
2. 修改自动预充逻辑之后，再次上电尝试，整车正常上高压，且进入 *Ready* 状态，挂*D*挡油泵正确响应，没有问题。

#### 高压上下电解读

​	通过采集 *CAN* 报文，使用 *CANoe* 解析波形，可以从中看出高压上下电时，相关 *ECU* 的一些动作变化。

* 上高压

​	首先，上低压（*KEY_ON*）之后，各个 *ECU* 设备进行唤醒，*PDU* 自检发送各个接触器的状态，如果无接触器粘连，则发送允许蓄电池上电；*BMS* 自检电池状态，然后反馈是否允许上电；*VCU* 接收到 *PDU*上继电器状态均为断开以及无粘连时，*VCU* 请求蓄电池上电；

​	由于主负继电器由外部硬线控制，*PDU* 只做继电器状态的判断。

​	钥匙 *KEY_START* 挡，上高压硬线信号，*VCU* 接收该信号后进行处理，根据 *BMS* 与 *PDU* 报文判断可以上高压，则发送主接触器闭合命令，*PDU* 接收到主接触器闭合之后，（因为没有单独的预充接触器控制命令）自动进行主接上高压预充过程，预充完毕之后，先闭合主接触器，再断开预充接触器。

​	主接闭合之后（主接与主负同时闭合），然后是 *VCU* 发送 *DCDC* 接触器闭合命令， *DCDC* 闭合， *DCDC* 闭合之后，*VCU* 就发送 *DCDC* 工作命令， *DCDC* 运行。然后是 *TMS* 继电器闭合。在上述接触器都吸合之后，*VCU* 下发上高压请求到 *BMS*，*BMS* 使动力电池输出高压直流电，上电过程结束。

<img src="C:\Users\10637\AppData\Roaming\Typora\typora-user-images\image-20251022172306969.png" alt="image-20251022172306969" style="zoom:67%;" />

* 下高压

​	钥匙 *KEY_OFF* 信号输入，*VCU* 接收到后，判断为下电信号，先输出请求下高压指令到 *BMS*，动力电池停止输出高压直流电。失能 *DCDC* 工作，此时先后断开 *DCDC*，主接（主负），TMS接触器。高压下电完成，被动放电是一个缓慢下电的过程，如果需要快速下电就需要进行主动放电。

<img src="C:\Users\10637\AppData\Roaming\Typora\typora-user-images\image-20251023084127630.png" alt="image-20251023084127630" style="zoom: 50%;" />



## DCDC程序修改以及验证

​	*DCDC* 程序为欣锐研发，提供了相关的修改指南，只需要根据修改指南，对 *DCDC* 程序的 *CAN* 通信部分做调整，基本上就是没什么问题的。其中 *DCDC* 的功率跟输出电压，可能会与软件模板相匹配，不能随便调整，否则会存在炸管的风险。

### 修改指南

1. *CAN* 报文 *ID* 使用宏定义声明，*CAN_REIDx* 为接收 *ID* 宏，*CAN_TEIDx *为发送 *ID* 宏，标准帧赋值：`ID<<2`；扩展帧赋值：`ID | 0x80000000`。

   > 注：*x = 1 *的 *ID* 宏是欣锐内部烧录 *CAN ID*，不可以更改。

2. 接收函数`CAN_Receivex(void)`与发送函数`CAN_Send_STATEx()`均位于`Handle_eCAN(void)`函数中，*CAN.c* 文件下，接收通常仅需接收 *VCU* 下发的 *DCDC* 工作命令，发送可能存在多个注意邮箱匹配，以及发送周期的调整；

   > 注：上述函数后的*x*，其可以为*0~n*，为*0*时则没有该*x*表示的数字。

3. 发送 *DCDC* 相关信息的变量时，需要注意变量的分辨率，公式：**通信协议分辨率\* 报文 = 实际值 = 程序分辨率\*程序变量**，且注意像 *DC* 温度变量，可能自身就已经存在偏移量的情况；

   > 注：通常再函数前都会声明变量的分辨率以及偏移量。
   >
   > ![image-20251024093336865](C:\Users\10637\AppData\Roaming\Typora\typora-user-images\image-20251024093336865.png)

### 测试验证

​	由于 *DCDC* 程序需要修改的内容不多，该模板与实际项目的 *DCDC* 匹配，变更通信协议之后，进行实车验证。将 *DCDC* 程序烧录后，正常上高压测试，*DCDC* 可以正常工作，验证完成。

