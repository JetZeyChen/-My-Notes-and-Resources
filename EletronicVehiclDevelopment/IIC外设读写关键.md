# IIC外设的读写操作

## 复位模块

​	在模式寄存器I2C_MDR中的IRS位置0，则I2C外设复位，I2C_STR状态寄存器中的所有位都会恢复为默认值。I2C模块失能直到IRS变为1。SDA与SCL引脚为高阻态。

> **当配置或者重新配置I2C模块时，IRS必须置0，保持失能状态**。

## 中断标志

​	状态寄存器中有着每一个中断的标志位，相关的时间产生标志位就会置1，如果中断使能寄存器中断相关中断没有使能，那么中断将会阻塞而不会传递到CPU。

​	所以可以不使能中断，而直接读取相关的标志位判断当前的状态。

> CPU读取I2C_STR状态寄存器后，除了ARDY,RRDY,XRDY位需要手动置1清除，其他位都会自动清除。

​	在FIFO模式中，请不要在使用发送准备中断标志和接收准备中断标志，请使用FIFO的中断标志。

* FIFO发送中断，当发送数据字节数量的值大于或者等于设定值时产生；
* FIFO接收中断，当接收数据字节数量的值大于或者等于设定值时产生。

## 重复模式VS非重复模式

### 重复模式（I2C_MDR RM = 1）

​	如果在模式寄存器中设置为重复模式，那么IIC将会一直发送数据，知道应用程序发送一个停止信号。此时在I2C_CNT寄存器中的计数值将会被忽略。

### 非重复模式（I2C_MDR RM = 0）

​	如果在非重复模式中，需要设置发送的字节数量到IIC_CNT寄存器中，当寄存器计数为0时，则会产生相应的事件。**如果I2C_CNT的计数值为0，将意味着发送65536个字节数据**。

* 如果I2C_MDR中的STP = 0，内部数据计数器计数到0时ARDY位将会置1。
* 如果I2C_MDR中的STP = 1，内部数据计数器计数到0时ARDY位不会置1，I2C外设会产生STOP信号。

> **注意：不管是什么模式下，一旦开启了I2C传输事务，就不能切换模式，直到一个有STOP信号标志I2C传输事务完成。**



注：EEPROM芯片的内部写入周期为4ms，不管是字节写入还是页写入都是一样的，所以循环写入的间隔必须大于该值。



## 寄存器

### I2C_OAR 所属地址寄存器

​	其内部存储的是I2C外设自身的从机地址，区别于其他连接在I2C总线上的从机地址。

### I2C_STR 状态寄存器

​	其是用于决定哪个中断产生以及读取状态信息的16位寄存器。

### I2C_MDR 模式寄存器

​	其是包含I2C外设的控制位的16位寄存器。如下是一些关键位：

* **NACKMOD**

  在主机接收模式下，该位不需要置1，会在内部的数据计数器计数为0时自动返回NACK信号结束接收。如果想要提前发送NACK信号，则需要手动置1。

* **STT**

  START信号位，在主机模型下，置1会产生一个起始信号到I2C总线上，当START信号发出之后，会自动清零。

* **STP**

  STOP信号位，在主机模型下，当内部数据计数器计数到0时发送STOP信号到I2C总线上，当STOP信号发出之后，会自动清零。