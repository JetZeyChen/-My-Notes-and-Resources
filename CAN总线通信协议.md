# CAN总线通信协议

​	CAN 是 Controller Area Network 控制区域网的缩写（以下称为 CAN），是 ISO国际标准化的串行通信协议。在当前的汽车产业中，出于对安全性、舒适性、方便性、低公害、低成本的要求，各种各样的电子控制系统被开发了出来。由于这些系统之间通信所用的数据类型及对可靠性的要求不尽相同，由多条总线构成的情况很多，线束的数量也随之增加。为适应“减少线束的数量”、“通过多个 LAN，进行大量数据的高速通信”的需要。

​	CAN 最初出现在80年代末的汽车工业中，由德国 Bosch 公司最先提出。当时，由于消费者对于汽车功能的要求越来越多，而这些功能的实现大多是基于电子操作的，这就使得电子装置之间的通讯越来越复杂，同时意味着需要更多的连接信号线。提出 CAN 总线的最初动机就是为了解决现代汽车中庞大的电子控制装置之间的通讯，减少不断增加的信号线。于是，他们设计了一个单一的网络总线，所有的外围器件可以被挂接在该总线上。1993年，CAN 已成为国际标准 ISO11898(高速应用)和 ISO11519（低速应用）。 

​	CAN 是一种多主方式的串行通讯总线，基本设计规范要求有高的位速率，高抗电磁干扰性，而且能够检测出产生的任何错误。当信号传输距离达到10Km 时，CAN 仍可提供高达50Kbit/s 的数据传输速率。由于 CAN 总线具有很高的实时性能，现在，CAN 的高性能和可靠性已被认同，并被广泛地应用于工业自动化、船舶、医疗设备、工业设备等方面。



## CAN总线结构拓补

​	CAN总线上的一个终端设备称为一个节点（Node），在CAN网络中，没有主设备和从设备的区别。一个CAN节点的硬件部分一般由CAN控制器和CAN收发器两个部分组成。CAN控制器负责CAN总线的逻辑控制，实现CAN传输协议；CAN收发器主要负责MCU逻辑电平与CAN总线电平之间的转换。

​	CAN控制器一般是MCU的片上外设。CAN收发器一般是单独的芯片，并且根据CAN总线的结构不同，需要使用不同的CAN收发芯片。

### 开环CAN总线（低速）

​	两根信号线独立，各自串联一个2.2k欧的电阻。这种CAN总线网络由[ISO11519-2](https://zhida.zhihu.com/search?content_id=238720860&content_type=Article&match_order=1&q=ISO11519-2&zhida_source=entity)标准定义，是低速、远距离的CAN网络，通信速率最高125kbit/s。在40kbit/s速率时，总线最长距离可达1000m。

![img](https://pica.zhimg.com/v2-0bef8a50af574faaa859584240415400_1440w.jpg)

### 闭环CAN总线 （高速）

​	总线两端各连接一个120欧的电阻，两根信号线形成回路。这种CAN总线网络由ISO 11898标准定义，是高速、短距离的CAN网络，通信速率为125kbit/s到1Mbit/s。在1Mbit/s通讯速率时，总线长度最长达40m。

![img](https://pic1.zhimg.com/v2-ba99179d1b74a980c940dc316ff3fc00_1440w.jpg)

## CAN总线信号逻辑

​	CAN总线由两条信号线，分别为CANH和CANL。没有时钟信号，属于异步通信。采用双绞线传输差分信号，具有很强的抗干扰能力。通过CANH与CANL之间的电压差表示总线的电平。

​	其中总线电平逻辑遵循线“与”逻辑，当总线空闲时则为1，也称为隐性（Recessive）电平，此时两信号线实际电压差几乎为0；当节点抢占总线发送数据时，则为0，也称为显性（Dominant）电平，此时两信号线存在电压差。

![img](https://pic2.zhimg.com/v2-2a5c76bae6071721b00bba72c334f171_1440w.jpg)

> 其中，不同标准的CAN协议物理层定义的线性或隐性电平时，信号线CANH、CANL的实际电压有所不同，需要注意。

## CAN位时序和波特率

### 波特率

​	波特率也是可以称为传输速率，表示每秒传输的码元数量，单位B/Baud。在二进制编码中，其大小等于比特率bps（bits per second）。

### 位时序

​	位时序指的是CAN总线节点（设备）采样一个比特位的时序逻辑，由该时序逻辑的控制可以进行CAN总线位同步。而标称位时间 NBT （Normal Bit Time），表示一个位数据的时间，用于确定CAN总线波特率。其由以下几个段组成：

![img](https://pic3.zhimg.com/v2-7403ea4726024467492c655a2ec70a42_1440w.jpg)

* 同步段Synchronization Segment:时间长度 = 1tq，这个时间段内检测总线跳变沿，如果有跳变沿则表示同步，反之亦然。
* 位段1 Bit Segment 1：时间长度为：1~16tq±SJW，在该段结束时对电平进行采样。
* 位段2 Bit Segment 2：时间长度为：1~8tq±SJW，在该段结束时进行电平输出。

>tq(Time Quantum) 时间片，由CAN控制器时钟频率决定的最小时间长度。
>
>SJW（Re-synchronization Jump Width）再同步跳变宽度，用于进行位时序同步时对BS1和BS2的适应性调整。

### 

## CAN协议标准与规格





## CAN协议帧

### CAN帧类型以及用途

* 数据帧 Data Frame —— 发生单元向接收单元发送ID以及数据的帧；
* 遥控帧 Remote Frame —— 节点向网络上其他节点发出数据请求的帧；
* 错误帧 Error Frame —— 节点检测出错误时，通知其他节点的帧；
* 过载帧 Overload Frame —— 接收单元未准备好接收数据时发生的帧；
* 帧间空间 Inter-frame Space —— 将数据帧、遥控帧与其他帧分隔开的帧。

### CAN帧格式

1. 数据帧

   ​	数据帧格式如下图所示：

   ![img](https://pic2.zhimg.com/v2-cb248bfd2dcce2ae05234364df3a5235_1440w.jpg)

   ​	其中包含一下部分：

   * 帧起始 Start of Frame：表示帧开始，占1位，总线逻辑电平为0电平（CANH与CANL存在电压差），显性电平。

   * 仲裁段/标识段 ID ：标识帧，表示数据优先级的段。ID数字越小优先级越高，标准格式有11位ID，扩展格式有29位ID（用于解决复杂网络ID紧缺的问题）。

     > 仲裁规则：从该段MSB位开始比较，显性电平0的优先级高，直到最后一位找出优先级最高的ID的节点获得总线控制权。

   * 控制段 DLC（Data Length Control）：该段占6位，表示数据段的字节数。其中前两位保留位，以显性电平（0）发送，其余4位用来表示字节数。

     >0000b表示0字节，1000b表示8字节，其余情况类推。

   * 数据段 Data Segment:该段可包含0~8字节数据，且从MSB位开始发送。

   * CRC段 （Cyclic Redundancy Check）循环冗余校验段：由15位CRC位和1位CRC界定符构成。CRC的计算包含该段前所有段的数据位。

     > 

   * ACK段 Acknowledge Bit ：由1位ACK槽和1位ACK界定符构成（共2Bits），用于确认是否正常收发。

     >发送节点：2位为隐性电平；
     >
     >接收节点：ACK槽位显性电平表示正常接收，反之亦然。

   * 帧结束 End of Frame ：由7位隐性电平（1）组成，表示帧的结束。

     >由于EOF由7位隐性电平构成，所以帧包含的有效数据中不能存在**连续7位隐性电平**。

   * 

2. 遥控帧

   ​	![img](https://pica.zhimg.com/v2-e8439e9056fb28a31874026cbcc93310_1440w.jpg)

   ​	遥控帧与数据帧基本一致，其主要区别为：

   ​	1.遥控帧没有数据段，且其控制段表示的时需要接收的数据字节数；

   ​	2.遥控帧的RTR位为隐性电平（1），数据帧的RTR位为显性电平（0）。

3. 错误帧

   ​	用于在接收和发送消息时检测出错误通知错误的帧。错误帧由错误标志和错误界定符构成。

   ​	![img](https://pic1.zhimg.com/v2-48965b174e785142f8aa20a1682cc69c_1440w.jpg)

   ​	1.错误标志

   ​		（1）主动错误标志（6位显性电平 111 111）

   ​			由该发送单元本身引起的错误被该单元检测到时，发送的错误标志；

   ​		（2）被动错误标志（6位隐性电平 000 000）

   ​			由CAN总线上其他节点引起的错误被该单元检测到时，发送的错误标志；

   ​	2.错误界定符

   ​		由8位隐性电平组成（0000 0000），用于界定该帧是否为错误帧，而非其他帧。

4. 过载帧

   ​	过载帧构成与错误帧一致。

   > Q:所以过载帧跟错误帧没有区别？那为什么还有要独立说明

5. 帧间隔

   ​	帧间隔是用于分隔数据帧和遥控帧的帧。数据帧和遥控帧可通过插入帧间隔将本帧与前面的任何帧（数据帧、遥控帧、错误帧、过载帧）分开。

   > 过载帧与错误帧前**不能插入帧间隔**。

   ![img](https://pic3.zhimg.com/v2-8903b71925dcc841e944d0c68358dda0_1440w.jpg)

​		间隔为3位隐性电平（000）；总线空闲为隐性电平（0）；延迟传输，8 个位的隐性位。只在处于被动	错误状态的单元刚发送一个消息后的帧间隔中包含的段。



## CAN帧同步



## CAN帧错误
