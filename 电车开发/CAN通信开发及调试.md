# CAN 控制器使用说明

## CAN 控制器功能特性

* 适配ISO 11898-1标准
* 最高达1Mbps比特率
* 多时钟源
* 32个消息对象/邮箱，每个消息对象都有以下特性：
  * 可配置为接收/发送；
  * 可配置为标准11位ID / 29位扩展ID；
  * 支持可编程ID接收掩码；
  * 支持数据帧和遥控帧；
  * 携带0-8字节数据；
  * 奇偶校验配置和数据RAM；
* 每个消息对象具有独立ID掩码；
* 消息对象可编程FIFO模式；
* 自测操作具有可编程回环模式；
* 支持调式的挂起模式；
* 软件模块重启；
* 自动重连——再一个32位定时器判断为掉线后；
* 消息RAM奇偶校验状态机；
* 两个中短线；
* 支持DMA。

## CAN控制器架构

![image-20250822085942952](C:\Users\10637\AppData\Roaming\Typora\typora-user-images\image-20250822085942952.png)

### CAN 核心 CAN Core

​	CAN 核心由CAN协议控制器和Rx/Tx移位寄存器组成，用于处理所有ISO 11989 协议功能。

### 消息处理器 Message Handler

​	消息处理器是一个用于控制在Message RAM 和 CAN 核心的Rx/Tx移位寄存器数据交换的状态机。也用于处理接收滤波和当控制寄存器 Control Register 已编程中断请求生。

### 消息内存 Message RAM

​	消息内存可以存储32个CAN消息。

### 寄存器与消息对象访问 Register and Message Object Access

​	通过间接访问消息对象确保消息的一致性。在正常操作下，所有 CPU 和 DMA 都通过接口寄存器 Interface Registers 完成对消息 RAM 的访问。

​	三个接口寄存器组控制 CPU 对消息 RAM 的读和写访问。其中两个接口寄存器组 IF1 和 IF2 用于读和写访问，1个接口寄存器组 IF3 用于只读访问。接口寄存器拥有与消息RAM同样的字长。

​	在指明的测试模式中，消息RAM的内存映射可以被直接访问。

​	

## 功能说明

​	CAN模块根据ISO 11898-1 协议执行CAN 协议通信。比特率可以编程为最高达1Mbps。一个CAN收发器芯片需要连接到物理层，即CAN总线上。

​	在 CAN 网络上进行通信时，可以对各个消息对象进行配置。消息对象和标识符掩码存储在消息RAM中。

​	所有关于消息处理的功能都被实现在消息处理器中。这些功能包括：接收滤波，在消息RAM和CAN核心之间进行消息的传输；和处理由终端和DMA请求所生产的传输请求。

​	CAN的寄存器组可以由CPU通过模块接口直接访问。这些寄存器被用来控制和配置CAN核心和消息处理器，并且访问消息RAM。

### 配置设备引脚

​	GPIO mux寄存器必须被配置此外设连接到设备引脚。为了避免引脚上出现的小毛病，GPyGMUX 位必须首先被配置（同时保持相关的GPyMUX位为默认0），然后将GPyMUX寄存器写入所需的值。

​	一些I/O的功能由独立于外设的GPIO寄存器设定定义的。对于输入信号，GPIO输入量应该通过设定相应的GPxQSELn寄存器的为11b设置为异步模式。内部输入上拉可以在GPyPUD寄存器进行配置。

​	查看GPIO章节获得更多关于GPIO mux的细节和设定。

### 地址/数据总线桥	

​	CAN模块使用特殊的寻址表来支持字节寻址。推荐只使用32位的

## 操作模式

### 初始化

​	初始化模式由软件（通过设置CAN_CTL寄存器的Init位），硬件复位或者掉线进入。在Init位置1的同时，从CAN总线的接收/发送传输就会停止，并且CAN_TX的状态输出是隐性。CAN错误计数器不会更新。设置Init位不会改变其他任何配置寄存器。

​	为了初始化CAN控制器，CPU必须配置CAN的位时序和用于CAN通信的消息对象。不需要的消息对象，可以通过清除它们的MsgVal位失活。

​	当在CAN控制寄存器的Init和CCE位都置1时，可以访问位时序寄存器配置位时序。

​	清除Init位完成软件的初始化。之后，比特流处理器（BSP）通过等待11个连续隐性比特序列（总线空闲）的出现，将自己同步到CAN总线上的数据传输，然后才能参与总线活动并开始消息传输。

​	消息对象的初始化独立于Init位，然而，

### CAN 消息传输 （默认模式）

#### 失能自动重传

#### 自动重连

### 测试模式







# CAN 驱动开发









# CAN 通信调试

