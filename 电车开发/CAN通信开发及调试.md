# CAN 控制器使用说明

## CAN 控制器功能特性

* 适配ISO 11898-1标准
* 最高达1Mbps比特率
* 多时钟源
* 32个消息对象/邮箱，每个消息对象都有以下特性：
  * 可配置为接收/发送；
  * 可配置为标准11位ID / 29位扩展ID；
  * 支持可编程ID接收掩码；
  * 支持数据帧和遥控帧；
  * 携带0-8字节数据；
  * 奇偶校验配置和数据RAM；
* 每个消息对象具有独立ID掩码；
* 消息对象可编程FIFO模式；
* 自测操作具有可编程回环模式；
* 支持调式的挂起模式；
* 软件模块重启；
* 自动重连——再一个32位定时器判断为掉线后；
* 消息RAM奇偶校验状态机；
* 两个中短线；
* 支持DMA。

## CAN控制器架构

![image-20250822085942952](C:\Users\10637\AppData\Roaming\Typora\typora-user-images\image-20250822085942952.png)

### CAN 核心 CAN Core

​	CAN 核心由CAN协议控制器和Rx/Tx移位寄存器组成，用于处理所有ISO 11989 协议功能。

### 消息处理器 Message Handler

​	消息处理器是一个用于控制在Message RAM 和 CAN 核心的Rx/Tx移位寄存器数据交换的状态机。也用于处理接收滤波和当控制寄存器 Control Register 已编程中断请求生。

### 消息内存 Message RAM

​	消息内存可以存储32个CAN消息。

### 寄存器与消息对象访问 Register and Message Object Access

​	通过间接访问消息对象确保消息的一致性。在正常操作下，所有 CPU 和 DMA 都通过接口寄存器 Interface Registers 完成对消息 RAM 的访问。

​	三个接口寄存器组控制 CPU 对消息 RAM 的读和写访问。其中两个接口寄存器组 IF1 和 IF2 用于读和写访问，1个接口寄存器组 IF3 用于只读访问。接口寄存器拥有与消息RAM同样的字长。

​	在指明的测试模式中，消息RAM的内存映射可以被直接访问。

​	

## 功能说明

​	CAN模块根据ISO 11898-1 协议执行CAN 协议通信。比特率可以编程为最高达1Mbps。一个CAN收发器芯片需要连接到物理层，即CAN总线上。

​	在 CAN 网络上进行通信时，可以对各个消息对象进行配置。消息对象和标识符掩码存储在消息RAM中。

​	所有关于消息处理的功能都被实现在消息处理器中。这些功能包括：接收滤波，在消息RAM和CAN核心之间进行消息的传输；和处理由终端和DMA请求所生产的传输请求。

​	CAN的寄存器组可以由CPU通过模块接口直接访问。这些寄存器被用来控制和配置CAN核心和消息处理器，并且访问消息RAM。

### 配置设备引脚

​	GPIO mux寄存器必须被配置此外设连接到设备引脚。为了避免引脚上出现的小毛病，GPyGMUX 位必须首先被配置（同时保持相关的GPyMUX位为默认0），然后将GPyMUX寄存器写入所需的值。

​	一些I/O的功能由独立于外设的GPIO寄存器设定定义的。对于输入信号，GPIO输入量应该通过设定相应的GPxQSELn寄存器的为11b设置为异步模式。内部输入上拉可以在GPyPUD寄存器进行配置。

​	查看GPIO章节获得更多关于GPIO mux的细节和设定。

### 地址/数据总线桥	

​	CAN模块使用特殊的寻址表来支持字节寻址。推荐只使用32位的

## 操作模式

### 初始化

​	初始化模式由软件（通过设置CAN_CTL寄存器的Init位），硬件复位或者掉线进入。在Init位置1的同时，从CAN总线的接收/发送传输就会停止，并且CAN_TX的状态输出是隐性。CAN错误计数器不会更新。设置Init位不会改变其他任何配置寄存器。

​	为了初始化CAN控制器，CPU必须配置CAN的位时序和用于CAN通信的消息对象。不需要的消息对象，可以通过清除它们的MsgVal位失活。

​	当在CAN控制寄存器的Init和CCE位都置1时，可以访问位时序寄存器配置位时序。

​	清除Init位完成软件的初始化。之后，比特流处理器（BSP）通过等待11个连续隐性比特序列（总线空闲）的出现，将自己同步到CAN总线上的数据传输，然后才能参与总线活动并开始消息传输。

​	消息对象的初始化独立于Init位，然而，所有的消息对象在消息发送开始之前都要配置为特有的标识符或者设置为无效。

​	CPU可以在正常操作模式期间对消息对象进行配置变更。在建立之后，消息对象从接口寄存器到消息RAM进行传输。当正在处理的消息对象号小于等于上一次接收的消息对象时，接收滤波器就会被启用。这保证了即使正改动消息对象仍能保持消息一致性；例如：在有一个挂起的CAN帧接受期间。

### CAN 消息传输 （默认模式）

​	一旦CAN被初始化，并且Init位被复位为0。CAN核心就会自行与CAN总线进行同步然后准备通讯就绪。

​	如果消息通过了接收滤波，那么接收的消息被存在它们想对应的消息对象中。全部消息都被存储在消息对象中，包括：消息ID，数据控制位DLC和最高达8字节的数据。因此，例如，如果使用ID掩码，当一个接收的消息被存储的时候，消息ID位在消息对象中会由掩码变更为“无需关心”。

​	CPU可以在任何时间使用接口寄存器读/写每个消息，因为消息处理器提供了并发访问情况下的消息一致性。

​	将要发送的消息可以被CPU更新。如果对于消息来说存在一个永恒的消息对象（消息ID MSGID，控制位在配置期间设置，并且设置给多个CAN发送器），那么可以只更新数据字节。如果多个发送消息应该被指定到同一个消息对象，那么整个消息对象在被请求的消息传输之前配置完成。

​	多个消息对象的传输可以在同一时间发起。消息对象根据它们内部的优先级按顺序传输。即使一个传输请求扔然挂起，在任何时间消息都可以更新或者设置为无效。然而，如果一个消息在一个挂起的传输已经开始之前变更，那么数据字节会被丢弃。

​	依赖于消息对象的配置，通过接收一个与之匹配的ID的远程帧会自动地请求数据传输。

#### 失能自动重传

​	根据CAN协议，CAN提供一个状态机在传输期间去自动的重发已经失去仲裁或者已经被错误干扰的帧。在传输成功完成之前，不会向用户确认帧传输服务。

​	默认情况下自动重发是使能状态。可以通过设定CAN控制寄存器的DAR位为1去失能。

#### 自动重连

​	在CAN已经进入掉线状态之后，通过重置Init位CPU可以开始一个掉线恢复序列。如果这个过程没实现，模块会保持在掉线状态。

​	CAN提供一个自动的自动在线功能，该功能由ABO位使能。CAN会自动地开始掉线恢复序列。该序列可以被用户定义的时钟周期延迟。

> 注：如果CAN模块由于多个CAN总线错误进入掉线状态，CAN会停止所以总线活动并且自动地置位Init位。一旦Init位由应用清除（或者由于自动重连功能），在回复正常模式之前设备会等待出现129个总线空闲信号（=129个11位连续隐形位）。不可以通过置位或复位Init位缩短掉线恢复序列。在掉线恢复序列的最后，错误计数器会被重置。在Init为重置之后，每一次监测到总线空闲信号，一个Bit0错误码就会被写到错误和状态寄存器。这使得CPU可以检查CAN总线是否被线性堵塞或者连续干扰，并且监控掉线恢复序列的进行。

### 测试模式

​	CAN模块提供几个测试模式，主要用于自测目的。对于所有的测试模式，在CAN控制寄存器中的Test位都要置位为1去使能对CAN测试寄存器的写访问。

#### 静默模式

​	静默模式可以在不发送显性位影响CAN总线的情况下分析通信状况（例如，确认位，过载标志，和激活错误标志）。CAN仍然可以接受有效数据帧和远程帧，但不会发送任何显性位。然而，接收的帧会被内部路由到CAN核心。

![image-20250824190052784](C:\Users\JetzeyChen\AppData\Roaming\Typora\typora-user-images\image-20250824190052784.png)



#### 回环模式

​	回环模式主要用来硬件自测。在该模式，CAN核心使用从Tx输出到Rx输入的内部反馈。发送的消息同时视为接收的消息，如果它们都通过接收过滤就会被存储到消息对象总。CAN_Rx输入引脚的真实值被CAN核心忽视。发放的消息仍然可以被CAN_Tx引脚监控。

​	为了独立于外部仿真，在回环模式CAN核心无视确认错误（在确认槽的数据或者远程帧采样的隐性位）。

![image-20250824191505952](C:\Users\JetzeyChen\AppData\Roaming\Typora\typora-user-images\image-20250824191505952.png)

#### 外部回环模式

​	外部回环模式与回环模式很像。然而，其包括了从CAN核心到Tx引脚信号路径，Tx引脚本身和从Tx引脚到CAN核心的信号路径。当选择外部回环模式，CAN核心被连接到Tx引脚的输入缓冲区。通过该配置，Tx引脚的IO电路可以被测试。外部回环模式可以通过设定测试寄存器的ExL位为1激活。

> 注:当回环模式激活时（LBack 位为1），ExL位会被忽略。

![image-20250824192249090](C:\Users\JetzeyChen\AppData\Roaming\Typora\typora-user-images\image-20250824192249090.png)

#### 静默回环模式

​	同时设置LBack 和 Silent 位就可以组合回环模式和静默模式。在不影响CAN网络的情况下测试CAN的硬件。在该模式，CAN_Rx引脚从CAN核心断连，并且CAN_Tx引脚不会发送显性位。

![image-20250824192940678](C:\Users\JetzeyChen\AppData\Roaming\Typora\typora-user-images\image-20250824192940678.png)

## 多个时钟源

​	CAN位时序时钟通常由系统时钟SYSCLK产生。如果需要，位时序时钟可以直接由外部时钟源（XTAL）产生。

> CAN核心必须编程为每个位至少八个时钟周期。为了实现1Mbps的传输速率需要使用一个8Mhz或者更高频率的晶振。

## 中断特性

​	中断可以由两个中断线产生：CAN0INT和CAN1INT。中断线可以在CAN控制寄存器中设置对应的IE0，IE1为1进行使能。

​	CAN提供了三组中断源：消息对象中断，状态变更中断和错误中断。中断源可以通过中断寄存器的中断ID Int0ID和Int1ID位进行确定。当没有中断挂起时，寄存器保持0。每一个中断线会在中断寄存器中的检测域再次为0（这意味着中断复位）或者IE0和IE1复位之前，都会保持激活。在Int0ID域的值0x8000表明因为CAN核心已更新（非必要变更）错误和状态寄存器（错误中断或者状态中断）而挂起的一个中断。该中断有最高优先级。CPU可以通过读错误和状态寄存器更新（复位）RxOK，TxOK和LEC状态位，但CPU的写访问不会产生或者复位一个中断。

​	介于1和最后一个消息对象的序号之间的数值表明了中断源是其中一个消息对象。INT0ID和INT1ID指向有最高优先级的挂起的消息中断。消息对象1有最高优先级，最后一个消息对象有最低优先级。

​	一个中断服务流程ISR，可以从中断源读取消息，也可以在读消息的同时清除消息对象的IntPnd中断挂起标志位。（ClrIntPnd清除中断挂起标志位在IF1或者IF2命令寄存器中）。当中断挂起标志位被清除，中断寄存器指向下一个挂起中断的消息对象。

​	CAN模块有模块级别的中断和确认状态机。要启用CAN0和CAN1中断，必须在CAN_GLB_INT_EN寄存器中设置相应的位。当处理一个中断，使用CAN_GLB_INT_EN 和PIEACK 位确认该中断之前，必须清除独立的消息或者状态变更标志位。

### 消息对象中断

​	消息对象中断由消息对象的事件产生。由IntPnd，TxIE和RxIE 控制。消息对象中断可以路由到CAN0INT或CAN1INT线，这是由中断多路复用器寄存器控制的。

> 注意：写CAN_IFnMCTL的IntPnd位会强制产生中断。

### 状态变更中断

​	在错误和状态寄存器中的RxOK，TxOK和LEC事件都属于状态变更中断。状态变更中断组可以通过设置CAN控制寄存器的SIE位使能。如果SIE置位，每一个CAN帧，独立的总线错误，有效的CAN通信和独立的消息RAM配置都会产生一个状态变更中断。状态变更中断只能被路由到中断线CAN0INT(必须通过在CAN_CLT寄存器的IE0位置1使能)。

### 错误中断

​	PER，BOff 和 EWarn事件都属于错误中断。错误中断组可以通过置位EIE位使能。同样，错误中断也只能路由到CAN0INT中断线。

### DCAN中断的PIE术语

| Interrupt | CANA   | CANB   |
| --------- | ------ | ------ |
| CANINT0   | CANA_0 | CANB_0 |
| CANINT1   | CANA_1 | CANB_1 |

### 中断拓扑

​	邮箱的中断可以路由到CAN0INT或者CAN1INT线，而错误中断和状态变更中断只能路由到CAN0INT线。

![image-20250824203022627](C:\Users\JetzeyChen\AppData\Roaming\Typora\typora-user-images\image-20250824203022627.png)

![image-20250824203034023](C:\Users\JetzeyChen\AppData\Roaming\Typora\typora-user-images\image-20250824203034023.png)

## DMA特性



## 奇偶校验状态机



## 调试模式



## 模块初始化

​	通过硬件复位，message对象的MsgVal、NewDat、IntPnd和TxRqst位被重置为0。消息对象的配置是通过编程掩码、仲裁、控制和IF1/IF2接口寄存器组之一的数据位设置为所需的值来完成。通过将消息对象编号写入对应的IF1/IF2命令寄存器的比特位[7:0]，IF1/IF2接口寄存器的内容加载到消息内存中寻址的消息对象中。

​	位时序的配置要求CAN控制寄存器中的Init位置1另外设置CCE也置1。这对于消息对象的配置来说不是必需的。

​	当CAN控制寄存器中的Init位被清除后，CAN核的CAN协议控制器状态机和消息处理程序状态机开始控制CAN内部的数据流。接收到的消息，通过接受过滤的消息存储到消息RAM中；带有待定传输请求的消息被加载到CAN核心的移位寄存器中，并使用CAN总线进行传输。

​	当CPU清除Init和CCE时，可以同时使能中断线（将IE0和IE1设置为1）。状态中断“EIE”和“SIE”可以同时启用。

​	CAN通信可以控制中断驱动或轮询模式。中断寄存器指向那些IntPnd = 1的message对象。即使到CPU的中断线被禁用（IE0和IE1为0），寄存器也会被更新。

​	CPU可以从NewData寄存器和传输请求寄存器中并行轮询所有MessageObject的NewDat和TxRqst位。如果所有传输对象都按较小的编号分组，则轮询更容易。所有接收对象都按较高的数字分组。

## 配置消息对象

​	整个消息RAM都应该在初始化结束之前配置。在CAN通信期间也可以改变消息对象的配置。

#### 数据帧发送对象的配置

| MsgVal |  Arb  | Data  | Mask  | EoB  | Dir  | NewDat | MsgLst | RxIE | TxIE  | IntPnd | RmtEn | TxRqst |
| :----: | :---: | :---: | :---: | :--: | :--: | :----: | :----: | :--: | :---: | :----: | :---: | :----: |
|   1    | appl. | appl. | appl. |  1   |  1   |   0    |   0    |  0   | appl. |   0    | appl. |   0    |

* 仲裁位arbitration bits(ID[28:0]和Xtd位)由应用提供。定义了ID和外发消息的类型。如果使用11位ID（Xtd = 0），编程到ID[28:18]。在该情况下，ID[17:0]被忽略。
* 数据寄存器（DLC[3:0]和数据0-7）由应用给出。TxRqst 和 RmtEn 应该在数据有效之前不能置位。
* 如果TxIE置位，在一次消息对象的成功传输之后IntPnd位被置位。
* 如果RmtEn置位，一个匹配的远程帧会导致TxRqst位置位；远程帧会自主地由一个数据帧应答。
* 掩码位(Msk[28:0],UMask,MXtd和Mdir位)可以允许一组有相似一ID远程帧置位TxRqst位。Dir位不应被遮掩。如果没有远程帧被允许置位TxRqst位（RmtEn = ‘0’），ID遮掩必须失能（UMask = ‘0’）。

#### 远程帧发送对象的配置

​	没有必要去为远程帧的传输配置传输对象。为接收对象设置TxRqst将导致传输一个与配置此接收对象的数据帧具有相同标识符的远程帧。

#### 数据帧单个接收对象配置

| MsgVal |  Arb  | Data  | Mask  | EoB  | Dir  | NewDat | MsgLst | RxIE | TxIE  | IntPnd | RmtEn | TxRqst |
| :----: | :---: | :---: | :---: | :--: | :--: | :----: | :----: | :--: | :---: | :----: | :---: | :----: |
|   1    | appl. | appl. | appl. |  1   |  0   |   0    |   0    |  0   | appl. |   0    |   0   |   0    |

* 仲裁位arbitration bits(ID[28:0]和Xtd位)由应用提供。定义了ID和外发消息的类型。如果使用11位ID（Xtd = 0），编程到ID[28:18]。在该情况下，ID[17:0]被忽略。当一个有11位ID的数据帧被接收，ID[17:0]会被置‘0’。
* 当消息处理器在消息对象存储一个数据帧，它会存储接收数据长度码和相对应的数据字节数。如果数据长度码少于8，剩余的消息对象字节会被覆盖为非指定值。
* 掩码位(Msk[28:0],UMask,MXtd和Mdir位)被用来（UMask = ‘1’）允许一组有相似ID的数据帧被接收。在典型应用中Dir位不应该被遮掩。如果掩码位的一些位被置为“无关紧要”，相关的仲裁寄存器的位会被存储的数据帧的位覆盖。
* 如果RxIE置位，ID与实际存储的仲裁位一致的远程帧的传输会被触发。如果掩码位（UMask = ‘1’）被用来做接收过滤，仲裁位的内容可能会被改变。

#### 远程帧的单个接收对象配置

| MsgVal |  Arb  | Data  | Mask  | EoB  | Dir  | NewDat | MsgLst | RxIE | TxIE  | IntPnd | RmtEn | TxRqst |
| :----: | :---: | :---: | :---: | :--: | :--: | :----: | :----: | :--: | :---: | :----: | :---: | :----: |
|   1    | appl. | appl. | appl. |  1   |  1   |   0    |   0    |  0   | appl. |   0    |   0   |   0    |

* 远程帧接收对象可用来监控CAN总线上的远程帧。远程帧存储在接收对象不会触发数据帧的传输。远程帧的接收对象可扩展到FIFO缓冲区。
* UMask必须设置为‘1‘。掩码位(Msk[28:0],UMask,MXtd和Mdir位)应该设置为“必须匹配”或者“无关紧要”用来允许一组有相似ID的远程帧被接受。在典型应用中Dir位不应该被遮掩。
* 仲裁位arbitration bits(ID[28:0]和Xtd位)由应用提供。定义了ID和外发消息的类型。如果Mask位的一些位被设置为’无关紧要‘，仲裁位相应的位会被存储的远程帧的位覆盖。如果使用11位ID（Xtd = 0），编程到ID[28:18]。在该情况下，ID[17:0]被忽略。当一个有11位ID的数据帧被接收，ID[17:0]会被置‘0’。
* 数据长度码（DLC[3:0]）由应用给出。当消息处理器在消息对象中存储一个远程帧，会存储接收的数据长度码。数据对象的数据字节会保持不变。
* 如果RxIE被置位，当一个接收的远程帧被接受IntPnd位会被置位并且存储在消息对象中。

#### FIFO缓冲区的配置



## 消息处理



## CAN位时序



## 消息接口寄存器组



## 消息RAM



## 软件



## CAN寄存器







# CAN 驱动开发









# CAN 通信调试

