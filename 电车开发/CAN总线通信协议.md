# CAN总线通信协议

​	CAN 是 Controller Area Network 控制区域网的缩写（以下称为 CAN），是 ISO国际标准化的串行通信协议。在当前的汽车产业中，出于对安全性、舒适性、方便性、低公害、低成本的要求，各种各样的电子控制系统被开发了出来。由于这些系统之间通信所用的数据类型及对可靠性的要求不尽相同，由多条总线构成的情况很多，线束的数量也随之增加。为适应“减少线束的数量”、“通过多个 LAN，进行大量数据的高速通信”的需要。

​	CAN 最初出现在80年代末的汽车工业中，由德国 **Bosch** 公司最先提出。当时，由于消费者对于汽车功能的要求越来越多，而这些功能的实现大多是基于电子操作的，这就使得电子装置之间的通讯越来越复杂，同时意味着需要更多的连接信号线。提出 CAN 总线的最初动机就是为了解决现代汽车中庞大的电子控制装置之间的通讯，减少不断增加的信号线。于是，他们设计了一个单一的网络总线，所有的外围器件可以被挂接在该总线上。1993年，CAN 已成为国际标准 ISO11898(高速应用)和 ISO11519（低速应用）。 

​	CAN 是一种多主方式的串行通讯总线，基本设计规范要求有高的位速率，高抗电磁干扰性，而且能够检测出产生的任何错误。当信号传输距离达到10Km 时，CAN 仍可提供高达50Kbit/s 的数据传输速率。由于 CAN 总线具有很高的实时性能，现在，CAN 的高性能和可靠性已被认同，并被广泛地应用于工业自动化、船舶、医疗设备、工业设备等方面。



## CAN总线结构拓补

​	CAN总线上的一个终端设备称为一个节点（Node），在CAN网络中，没有主设备和从设备的区别。一个CAN节点的硬件部分一般由CAN控制器和CAN收发器两个部分组成。CAN控制器负责CAN总线的逻辑控制，实现CAN传输协议；CAN收发器主要负责MCU逻辑电平与CAN总线电平之间的转换。

​	CAN控制器一般是MCU的片上外设。CAN收发器一般是单独的芯片，并且根据CAN总线的结构不同，需要使用不同的CAN收发芯片。

### 开环CAN总线（低速）

​	两根信号线独立，各自串联一个2.2k欧的电阻。这种CAN总线网络由[ISO11519-2](https://zhida.zhihu.com/search?content_id=238720860&content_type=Article&match_order=1&q=ISO11519-2&zhida_source=entity)标准定义，是低速、远距离的CAN网络，通信速率最高125kbit/s。在40kbit/s速率时，总线最长距离可达1000m。

![img](https://pica.zhimg.com/v2-0bef8a50af574faaa859584240415400_1440w.jpg)

### 闭环CAN总线 （高速）

​	总线两端各连接一个120欧的电阻，两根信号线形成回路。这种CAN总线网络由ISO 11898标准定义，是高速、短距离的CAN网络，通信速率为125kbit/s到1Mbit/s。在1Mbit/s通讯速率时，总线长度最长达40m。

![img](https://pic1.zhimg.com/v2-ba99179d1b74a980c940dc316ff3fc00_1440w.jpg)

## CAN总线信号逻辑

​	CAN总线由两条信号线，分别为CANH和CANL。没有时钟信号，属于异步通信。采用双绞线传输差分信号，具有很强的抗干扰能力。通过CANH与CANL之间的电压差表示总线的电平。

​	其中总线电平逻辑遵循线“与”逻辑，当总线空闲时则为1，也称为隐性（Recessive）电平，此时两信号线实际电压差几乎为0；当节点抢占总线发送数据时，则为0，也称为显性（Dominant）电平，此时两信号线存在电压差。

![img](https://pic2.zhimg.com/v2-2a5c76bae6071721b00bba72c334f171_1440w.jpg)

> 其中，不同标准的CAN协议物理层定义的线性或隐性电平时，信号线CANH、CANL的实际电压有所不同，需要注意。

## CAN位时序和波特率

### 波特率

​	波特率也是可以称为传输速率，表示每秒传输的码元数量，单位B/Baud。在二进制编码中，其大小等于比特率bps（bits per second）。

### 位时序

​	位时序指的是CAN总线节点（设备）采样一个比特位的时序逻辑，由该时序逻辑的控制可以进行CAN总线位同步。而标称位时间 NBT （Normal Bit Time），表示一个位数据的时间，用于确定CAN总线波特率。其由以下几个段组成：

|            |      |      |            |           |
| ---------- | ---- | ---- | ---------- | --------- |
| 段Segment  | SS   | PTS  | PB1        | PB2       |
| 时长（tq） | 1    | 6    | 1~16tq±SJW | 1~8tq±SJW |



* 同步段Synchronization Segment:时间长度 = 1tq，这个时间段内检测总线跳变沿，如果有跳变沿则表示同步，反之亦然。
* 传播时间段 Propagation Time Segment ：由总线测试可获得平均值；
* 相位缓冲段1 Phase Buffer Segment 1：在该段结束时对电平进行采样。
* 相位缓冲段2 Phase Buffer Segment 2：在该段结束时进行电平输出。

>tq(Time Quantum) 时间片，由CAN控制器时钟频率决定的最小时间长度。
>
>SJW（resynchronization Jump Width）再同步跳变宽度，用于进行位时序同步时对BS1和BS2的适应性调整。



## CAN位同步

​	由于CAN是异步通信，且其通信速率通常比较高250kbps~1Mbps，为了能够使得两个通信节点能够正确采样接收数据，并进行时序同步是通信**可靠性**非常关键的步骤。为了实现位的同步，所以将每一个位分解为上述位时序的形式，对每一个比特位进行时间片划分。其中进行位同步的技术有以下两个：

* **硬同步**

  ​	将接收到的位时序中由空闲状态出现起始帧的位信号时，将接收位时序的SS段与该起始帧信号进行同步，这样确保了后续位时序的基本同步；

  ![image-20250818110920455](C:\Users\10637\AppData\Roaming\Typora\typora-user-images\image-20250818110920455.png)

* **再同步**

  ​	在传输帧的过程中，对由传输延迟造成的相位偏移，就需要通过再同步去进行时序的同步。其中由两种情况：

  * 相位超前：

    ​	当位时序中，电平跳变沿出现在SS段的后，称为位时序相位超前；此时可以通过调整增加PB2的持续时间然后使下一个位时序开始SS段与跳变沿同步。

  * 相位滞后：

    ​	当位时序中，电平跳变沿出现在SS段的前，称为位时序相位滞后；此时可以通过调整减小PB1的持续时间然后使下一个位时序开始SS段与跳变沿同步。

    > 调整时序持续时间长短的最大限度由SJW确定。必要时控制器会通过多次调整来实现同步，当控制器设置的 SJW 极限值较大时，可以吸收的误差加大，但通讯的速度会下降。



## CAN协议标准与规格

### 基础CAN协议标准

* **CAN2.0A**

  标准帧格式，具有11位ID，0~8字节数据，最大速率1Mbps（实际常用500Kbps）。

* **CAN2.0B**

  扩展帧格式，具有29位ID，解决网络ID资源不足问题，向下兼容**CAN2.0A**。

* **CAN FD**（Flexible Data-rate）

  1. 可变速率：仲裁段保持1Mbps，数据段速率提升至2~5Mbps；
  2. 数据扩容：单帧数据长度扩展至64字节；
  3. 协议版本：ISO 11898-1:2015和 ISO 11898-1:2020；
  4. 应用场景：电池管理系统BMS、ADAS传感器数据集聚合。

* **CAN XL** （第三代CAN协议）

  1. 技术定位：填补CAN FD 与汽车以太网（100Mbps以上）之间的带宽空白；
  2. 关键创新：分离仲裁ID与寻址ID；单帧数据最大支持2048字节，速率提升至10~20Mbps；物理层兼容CAN/CAN FD，支持混合组网；
  3. 标准化进程：2024年纳入ISO 11898-1/2标准体系。

### 应用层协议标准

* **CANopen**

  ​	定义设备对象字典（OD）、网络管理（NMT）、过程数据对象（PDO）等服务。主要应用与车载设备升级。

* **J1939(商用车专用)**

  ​	特点为基于CAN 2.0B扩展帧，定义车辆控制参数（如发动机转速、故障码）的PGN(Parameter Group Number)规则。

* #### 电动汽车换电通信标准 GB/T 32895-2025

  定义电池状态（SOC/SOH）、安全认证等报文格式。



## CAN协议帧

### CAN帧类型以及用途

* 数据帧 Data Frame —— 发生单元向接收单元发送ID以及数据的帧；
* 遥控帧 Remote Frame —— 节点向网络上其他节点发出数据请求的帧；
* 错误帧 Error Frame —— 节点检测出错误时，通知其他节点的帧；
* 过载帧 Overload Frame —— 接收单元未准备好接收数据时发生的帧；
* 帧间空间 Inter-frame Space —— 将数据帧、遥控帧与其他帧分隔开的帧。

### CAN帧格式

1. 数据帧

   ​	数据帧格式如下图所示：

   ![img](https://pic2.zhimg.com/v2-cb248bfd2dcce2ae05234364df3a5235_1440w.jpg)

   ​	其中包含一下部分：

   * 帧起始 Start of Frame：表示帧开始，占1位，总线逻辑电平为0电平（CANH与CANL存在电压差），显性电平。

   * 仲裁段/标识段 ID ：标识帧，表示数据优先级的段。ID数字越小优先级越高，标准格式有11位ID，扩展格式有29位ID（用于解决复杂网络ID紧缺的问题）。

     > 仲裁规则：从该段MSB位开始比较，显性电平0的优先级高，直到最后一位找出优先级最高的ID的节点获得总线控制权。
     >
     > 除了ID还有其他3个标志位：
     >
     > 1. RTR 位 (Remote Transmission Request Bit)，译作远程传输请求位，它是用于区分数据帧和遥控帧的，当它为显性电平时表示数据帧，隐性电平时表示遥控帧。
     > 2. IDE 位 (Identifier Extension Bit)，译作标识符扩展位，它是用于区分标准格式与扩展格式，当它为显性电平时表示标准格式，隐性电平时表示扩展格式。
     > 3. SRR 位 (Substitute Remote Request Bit)，只存在于扩展格式，它用于替代标准格式中的 RTR位。由于扩展帧中的 SRR 位为隐性位，RTR 在数据帧为显性位，所以在两个 ID 相同的标准格式报文与扩展格式报文中，标准格式的优先级较高。

   * 控制段 DLC（Data Length Control）：该段占6位，表示数据段的字节数。其中前两位保留位，以显性电平（0）发送，其余4位用来表示字节数。

     >0000b表示0字节，1000b表示8字节，其余情况类推。

   * 数据段 Data Segment:该段可包含0~8字节数据，且从MSB位开始发送。

   * CRC段 （Cyclic Redundancy Check）循环冗余校验段：由15位CRC位和1位CRC界定符构成。CRC的计算包含该段前所有段的数据位。

     > CRC 界定符，它为隐性位，主要作用是把 CRC 校验码与后面的 ACK段间隔起来。

   * ACK段 Acknowledge Bit ：由1位ACK槽和1位ACK界定符构成（共2Bits），用于确认是否正常收发。

     >发送节点：2位为隐性电平；
     >
     >接收节点：ACK槽位显性电平表示正常接收，反之亦然。

   * 帧结束 End of Frame ：由7位隐性电平（1）组成，表示帧的结束。

     >由于EOF由7位隐性电平构成，所以帧包含的有效数据中不能存在**连续7位隐性电平**。

   * 

2. 遥控帧

   ​	![img](https://pica.zhimg.com/v2-e8439e9056fb28a31874026cbcc93310_1440w.jpg)

   ​	遥控帧与数据帧基本一致，其主要区别为：

   ​	1.遥控帧没有数据段，且其控制段表示的时需要接收的数据字节数；

   ​	2.遥控帧的RTR位为隐性电平（1），数据帧的RTR位为显性电平（0）。

3. 错误帧

   ​	用于在接收和发送消息时检测出错误通知错误的帧。错误帧由错误标志和错误界定符构成。

   ​	![img](https://pic1.zhimg.com/v2-48965b174e785142f8aa20a1682cc69c_1440w.jpg)

   ​	1.错误标志

   ​		（1）主动错误标志（6位显性电平 000 000）

   ​			由该发送单元本身引起的错误被该单元检测到时，发送的错误标志；

   ​		（2）被动错误标志（6位隐性电平 111 111）

   ​			由CAN总线上其他节点引起的错误被该单元检测到时，发送的错误标志；

   ​	2.错误界定符

   ​		由8位隐性电平组成（1111 1111），用于界定该帧是否为错误帧，而非其他帧。

4. 过载帧

   ​	过载帧构成与错误帧一致。

   > Q:所以过载帧跟错误帧没有区别？那为什么还有要独立说明
   >
   > 过载帧的电平信号与错误帧的电平信号是否不一致，但是它们的帧结构组成是一致的。

5. 帧间隔

   ​	帧间隔是用于分隔数据帧和遥控帧的帧。数据帧和遥控帧可通过插入帧间隔将本帧与前面的任何帧（数据帧、遥控帧、错误帧、过载帧）分开。

   > 过载帧与错误帧前**不能插入帧间隔**。

   ![img](https://pic3.zhimg.com/v2-8903b71925dcc841e944d0c68358dda0_1440w.jpg)

​		间隔为3位隐性电平（111）；总线空闲为隐性电平（1）；延迟传输，8 个位的隐性位。只在处于被动错误状态的单元刚发送一个消息后的帧间隔中包含的段。



## CAN总线仲裁

1. 当总线处于空闲模式时，任何最先抢占总线的节点获得总线权限；
2. 当多个节点同时抢占总线权限时，通过仲裁段（ID）进行总线仲裁，从最高有效位MSB开始逐位比较，位显性电平0的发送单元抢占总线，直到LSB结束。最直观的判断便是，ID号数字越小，优先级越高。
3. 相同ID和格式的数据帧和遥控帧，数据帧具有更高优先级，因为数据中的RTR位是显性电平，而遥控帧的RTR位是隐性电平；
4. 对于11位标准ID相同的标志数据帧和扩展数据帧，标准数据帧具有更高的优先级，因为标志数据帧的IDE位是显性电平，而扩展数据帧的IDE位是隐性电平。



## CAN帧错误

* 位错误
* 填充错误
* CRC错误
* 格式错误
* ACK错误



>注：以上内容参考自：
>
>1.[(2 封私信) CAN总线通信详解 (超详细配34张高清图) - 知乎](https://zhuanlan.zhihu.com/p/677658199)
>
>2.[秀！靠这篇我竟然2天理解了CAN协议！实战STM32F4 CAN！_can协议的命令表怎么理解-CSDN博客](https://blog.csdn.net/XiaoXiaoPengBo/article/details/116206252)

## 相关疑问

### Q1:PC如何通过CAN卡与VCU的诊断CAN总线接口进行通信，获取CAN报文查看故障信息，PC上是否存在如串口调试助手一样的上位机软件？

A：（以下内容源自Deepseek）

​	PC的USB接口连接与VCU的CAN接口之间需要使用一种将USB协议转为CAN协议的硬件设备，也叫CAN总线分析仪，俗称CAN卡。设备的国外知名品牌为**PEAK**，国内较为知名的为同星**TOSUN**。CAN卡接入VCU需要专门的转接线缆如：DB9转OBD-II线缆。

* **PEAK国际大厂工具链**

​	PEAK官方的PEAK PCAN-USB FD设备，可以通过PEAK官网下载PCAN驱动，然后使用配套的上位机软件PCAN-View，选择相关通道，并配置波特率帧格式等参数，点击"Start"，VCU上电后即可获得CAN通信原始报文流。

​	**UDS诊断示例：**

​	1.在PCAN-View发送窗口输入：

​	ID: 0x7E0   Data: 02 10 03 00 00 00 00 00   // UDS请求：进入诊断会话（10 03）  

​	2.等待VCU响应：

​	ID: 0x7E8   Data: 06 50 03 00 32 01 F4 AA   // 06：响应长度；50：肯定响应+10；03：会话模式

> ID：0x7E8表示动力CAN，ID：0x7E0是VCU地址。 

*  **TOSUN国内自产工具链**

  ​	其由TC、TL、TS三大产品线，分别应对不同工业化需求。突出优势为其推出的**TSMaster**软件，90%功能都免费使用，包括嵌入式代码生成、总线监控、记录、回放、RBS仿真、C脚本、小程序等。自己配置部分UDS诊断功能免费提供，支持第三方硬件，包括Vector，PEAK，Kvaser，ICS，ZLG等。

### Q2:对于诊断、刷写、标定三个关键的ECU开发相关流程，分别设计到UDS、XCP两种不同的应用层协议，其底层传输协议均为CAN协议，那么对于同一个CAN卡连接的PC与ECU，进行上述功能，只需要使用相应的上位机软件进行操作就可以吗？

A:



## UDS协议

​	UDS（Unified Diagnostic Services，统一诊断服务）是ISO 14229标准定义的汽车电子系统诊断协议，用于ECU（电子控制单元）的故障诊断、刷写、参数标定等操作。其核心架构基于客户端-服务器模型（诊断仪为客户端，ECU为服务器），通过CAN/LIN/Ethernet等物理层传输。

### 协议分层与通信基础

1. **OSI模型映射**

   | 层级Layer | 实现协议Protocol         | 功能Function                         |
   | --------- | ------------------------ | ------------------------------------ |
   | 应用层    | UDS（ISO 14229）         | 定义诊断服务（SID）和响应格式        |
   | 传输层    | ISO-TP（ISO 15765-2）    | 处理长报文分段与重组（最大4095字节） |
   | 网络层    | CAN/CAN FD （ISO 11898） | 物理帧传输（标准帧/扩展帧）          |

   

2. **寻址方式**

   * **物理寻址**：诊断仪直接访问目标ECU（请求ID：`0x7E0`，响应ID：`0x7E8`）。
   * **功能寻址**：广播模式，多个ECU同时响应（请求ID：`0x7DF`）。

   

### 核心诊断服务

#### **1. 诊断控制类（10系列）**

| **服务**     | **SID** | **功能**                       | **示例指令（HEX）**        |
| :----------- | :------ | :----------------------------- | :------------------------- |
| **会话控制** | 0x10    | 切换诊断模式（默认/扩展/编程） | `10 03`（进入扩展会话）    |
| **安全访问** | 0x27    | 解锁安全等级（种子-密钥认证）  | `27 05`（请求Level 5种子） |
| **通信控制** | 0x28    | 关闭/开启ECU非诊断报文         | `28 03 01`（关闭应用报文） |

#### **2. 数据传输类（2x-3x系列）**

| **服务**         | **SID** | **功能**                       | **关键参数**                |
| :--------------- | :------ | :----------------------------- | :-------------------------- |
| **读数据**       | 0x22    | 读取DID（Data Identifier）数据 | `22 F1 0C`（读软件版本）    |
| **写数据**       | 0x2E    | 写入DID配置（如VIN码）         | `2E 80 01 00 01`            |
| **输入输出控制** | 0x2F    | 强制ECU引脚输出特定信号        | `2F 90 01 03`（点亮故障灯） |

#### **3. 故障管理类（14/19系列）**

| **服务**       | **SID** | **功能**                           | **响应解析**              |
| :------------- | :------ | :--------------------------------- | :------------------------ |
| **清除故障码** | 0x14    | 删除DTC（Diagnostic Trouble Code） | `14 FF FF FF`（清除所有） |
| **读故障码**   | 0x19    | 查询DTC状态（如当前/历史码）       | `19 02 FF`（读当前故障）  |

#### **4. 远程编程类（34-37系列）**

| **服务**         | **SID** | **功能**                      | **刷写流程步骤**           |
| :--------------- | :------ | :---------------------------- | :------------------------- |
| **请求下载**     | 0x34    | 初始化固件传输（地址+大小）   | Step 1：`34 00 44 00 8000` |
| **传输数据**     | 0x36    | 发送数据块（最大4095字节/块） | Step 2：`36 01 [Data]`     |
| **请求退出传输** | 0x37    | 结束下载并校验CRC             | Step 3：`37`               |

> ​	该类服务主要用于对ECU进行程序**刷写Flashing**（刷写：通过诊断协议（如UDS）将**新版程序/固件**烧录至ECU的Flash存储器中，实现功能升级或故障修复。），刷写的具体流程以及关键步骤如下：
>
> 1. **进入编程会话**（UDS `0x10 02`）
>    - ECU重启至Bootloader模式，暂停应用层功能。
> 2. **安全认证**（UDS `0x27`）
>    - 种子-密钥验证，防止非法刷写（如`27 05`请求种子 → `67 05 [Seed]`）。
> 3. **擦除内存**（UDS `0x31`）
>    - 清除旧固件：`31 01 FF 00`（擦除指定Flash扇区）。
> 4. **传输固件**（UDS `0x34/0x36/0x37`）
>    - **请求下载**（`0x34`）：声明固件地址与大小（如`34 00 44 00 8000` = 地址0x440000，大小32KB）。
>    - **传输数据**（`0x36`）：分块发送HEX文件（每块≤4095字节）。
>    - **退出传输**（`0x37`）：结束下载并校验CRC。
> 5. **复位ECU**（UDS `0x11`）
>    - 退出Bootloader，重启运行新程序。

### 报文结构与机制

#### **1. 请求与响应格式**

- **请求帧**：`[SID] + [子功能/参数] + [数据]`
  示例：`0x22 0xF1 0x0C`（读取DID=F10C的数据）
- **肯定响应**：`[SID + 0x40] + [数据]`
  示例：`0x62 0xF1 0x0C 0x12 0x34`（返回数据：12 34）
- **否定响应**：`[0x7F] + [SID] + [NRC]`
  示例：`0x7F 0x22 0x31`（NRC=31：请求超时）

#### **2. 长报文传输（ISO-TP）**

- 单帧（SF）：数据≤7字节时直接发送（首字节高4位=0）。
- 首帧（FF）：数据＞7字节时发送首帧（首字节高4位=1），包含总长度。
- 流控帧（FC）：接收方控制发送速率（块大小/间隔时间）。
- 连续帧（CF）：后续数据分块发送（首字节高4位=2）。

> 注：实际开发需结合具体ECU的**诊断需求规范（DID/DTC定义）** 和**厂商扩展服务**（如0xF0-0xFF为私有SID）

## XCP协议

​	XCP（Universal Measurement and Calibration Protocol，通用测量与标定协议）是用于**实时访问ECU内存数据**的汽车电子标定协议，替代传统的CCP（CAN Calibration Protocol），支持多物理层传输与高性能数据交互。

#### **核心目标**

- **实时读写ECU内存**：动态调整参数（如PID增益、MAP图）、捕获运行时变量（如传感器原始值）。
- **同步测量**：高速采集多ECU信号（如电机转速+电池温度），精度达μs级。

#### **对比CCP的核心升级**

| **维度**       | **CCP**               | **XCP**                                      |
| :------------- | :-------------------- | :------------------------------------------- |
| **物理层**     | 仅支持CAN             | 支持CAN/CAN FD、Ethernet、FlexRay、SPI       |
| **传输效率**   | CAN带宽限制（≤1Mbps） | 以太网可达1Gbps                              |
| **数据包结构** | 固定8字节数据域       | 动态长度（CAN FD：64字节，以太网：1500字节） |
| **时钟同步**   | 需额外SYNC报文        | 集成时间戳（CTO/DTO）                        |

#### **通信模式**

- **命令传输对象（CTO）**：
  - 主机（标定工具）→ 从机（ECU）发送控制指令（如`WRITE_MEMORY`）。
  - 包结构：`[PID] + [CMD] + [DATA]`（PID：数据包标识符）。
- **数据传输对象（DTO）**：
  - 从机 → 主机传输测量数据或事件响应（如`DAQ`数据流）。

####  **参数标定流程**

> **参数标定**：在不修改ECU程序的前提下，通过**实时调整运行参数**优化控制器性能。
>
> - **标定对象**：MAP图（如扭矩-转速曲线）、阈值（如温度报警值）、PID参数。
> - **适用场景**：发动机空燃比优化、电池SOC校准、电机效率提升。
>
> 1. **数据映射**
>
>    - 使用**A2L文件**（ASAP2标准）定义ECU内存中可标定参数的地址、数据类型、物理量转换公式。
>
>    - 示例：定义油门MAP图
>
>      ```
>      /begin MEASUREMENT Throttle_Map
>        ECU_ADDRESS 0x8010F00
>        FORMAT "%6.2"
>        PHYSICAL_UNIT "%"
>        /begin AXIS_DESCR
>          AXIS_PTS_REF Throttle_RPM_Axis  // X轴：转速
>          AXIS_PTS_REF Throttle_Pedal_Axis // Y轴：踏板开度
>        /end
>      /end
>      ```
>
> 2. **实时修改参数**
>
>    - **协议**：CCP（CAN Calibration Protocol）或XCP（Universal Measurement and Calibration Protocol）。
>      - **XCP优势**：支持CAN/Ethernet/FlexRay，传输速率更高（以太网可达1Gbps）。
>    - **工作模式**：
>      - **在线标定**：ECU运行时动态修改RAM中的参数（需ECU支持双RAM映射）。
>      - **离线标定**：修改Flash参数，需重启生效。

1. **连接ECU**：
   - 主机发送`CONNECT` → ECU返回通信模式（如`CAN@500kbps`）。
2. **解锁资源**：
   - 安全认证（类似UDS种子-密钥），例如`GET_SEED` → `UNLOCK`。
3. **修改参数**：
   - `SHORT_UPLOAD`读取当前值 → `DOWNLOAD`写入新值。
4. **固化至Flash**（可选）：
   - `PROGRAM`命令将RAM参数写入非易失存储器。

#### **高速数据采集（DAQ）**

- **配置步骤**：
  1. 定义ODT（Object Descriptor Table）：描述待采集信号的内存地址与长度。
  2. 绑定事件（如100μs定时器）：`SET_DAQ_PTR` + `WRITE_DAQ`。
  3. 启动采集：`START_STOP_DAQ_LIST`。

### 文件格式

**A2L文件（ASAP2标准）**：

- 描述ECU内存结构：参数地址、数据类型、转换公式、标定范围。

例：

> ```
> /begin CHARACTERISTIC Torque_Map  // 扭矩MAP参数
>   ADDRESS 0x8010F00
>   FORMAT "%6.2"
>   AXIS_DESCR RPM_AXIS  // X轴：转速
>   AXIS_DESPR Pedal_AXIS // Y轴：踏板开度
> /end
> ```
